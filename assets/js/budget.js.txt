import { appState } from './main.js';
import { saveDataToFirestore } from './firestore.js';
import { formatCurrency } from './utils.js';

let budgetModals = {
    income: null,
    expense: null,
    categoryManager: null
};

/**
 * Initializes all event listeners for the Budget Tool page.
 */
export function initializeBudgetTool() {
    // Use event delegation on the body for elements that might not exist on page load
    document.body.addEventListener('click', e => {
        const target = e.target;
        
        if (target.id === 'addIncomeBtn') handleAddIncome();
        if (target.id === 'addExpenseBtn') handleAddExpense();
        if (target.id === 'saveIncomeBtn') handleSaveIncome();
        if (target.id === 'saveExpenseBtn') handleSaveExpense();
        if (target.closest('.edit-income-btn')) handleEditIncome(target.closest('.edit-income-btn'));
        if (target.closest('.edit-expense-btn')) handleEditExpense(target.closest('.edit-expense-btn'));
        if (target.id === 'deleteIncomeBtn') handleDeleteIncome();
        if (target.id === 'deleteExpenseBtn') handleDeleteExpense();
        if (target.id === 'budgetEditBtn') handleSaveBudgetName();

        // Category Manager Listeners
        if (target.id === 'manageCategoriesBtn') handleManageCategories();
        if (target.id === 'addMainCategoryBtn') handleAddMainCategory();
        if (target.closest('.add-subcategory-btn')) handleAddSubCategory(target.closest('.add-subcategory-btn'));
        if (target.closest('.delete-main-category-btn')) handleDeleteMainCategory(target.closest('.delete-main-category-btn'));
        if (target.closest('.delete-subcategory-btn')) handleDeleteSubCategory(target.closest('.delete-subcategory-btn'));
    });

    document.body.addEventListener('change', e => {
        if (e.target.id === 'expenseCategory') {
            populateSubCategoryDropdown();
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        // Initialize modal instances once the DOM is fully loaded
        const incomeModalEl = document.getElementById('incomeModal');
        const expenseModalEl = document.getElementById('expenseModal');
        const categoryModalEl = document.getElementById('categoryManagementModal');
        if(incomeModalEl) budgetModals.income = new bootstrap.Modal(incomeModalEl);
        if(expenseModalEl) budgetModals.expense = new bootstrap.Modal(expenseModalEl);
        if(categoryModalEl) {
            budgetModals.categoryManager = new bootstrap.Modal(categoryModalEl);
            // Re-populate dropdowns when the manager is closed to reflect changes
            categoryModalEl.addEventListener('hidden.bs.modal', () => populateCategoryDropdowns());
        }
    });
}

/**
 * Main render function for the budget tool.
 */
export function renderBudgetTool() {
    if (!appState.data.budgets || appState.data.budgets.length === 0) return;

    // For simplicity, we'll work with the first budget
    const budget = appState.data.budgets[0];
    if (!budget) return;

    const incomeListEl = document.getElementById('incomeList');
    const expenseListEl = document.getElementById('expenseList');
    const incomeTotalEl = document.getElementById('incomeTotal');
    const expenseTotalEl = document.getElementById('expenseTotal');
    const savingsSectionEl = document.getElementById('savingsSection');
    const budgetNameInput = document.getElementById('budgetName');

    if(budgetNameInput) budgetNameInput.value = budget.name;

    // Render Income
    let totalIncome = 0;
    if (incomeListEl) {
        incomeListEl.innerHTML = budget.income.map(item => {
            totalIncome += item.amount;
            return `
                <div class="list-item">
                    <span class="list-item-name">${item.source}</span>
                    <span class="list-item-amount">${formatCurrency(item.amount)}</span>
                    <button class="btn btn--secondary btn-sm edit-income-btn" data-id="${item.id}">Edit</button>
                </div>`;
        }).join('');
    }

    // Render Expenses
    let totalExpenses = 0;
    if (expenseListEl) {
        const groupedExpenses = budget.expenses.reduce((acc, item) => {
            totalExpenses += item.amount;
            const parts = item.category.split('-');
            const main = parts[0];
            const sub = parts.length > 1 ? parts.slice(1).join('-') : null;
            if (!acc[main]) acc[main] = { total: 0, items: [] };
            acc[main].total += item.amount;
            acc[main].items.push({ ...item, subCategory: sub });
            return acc;
        }, {});

        expenseListEl.innerHTML = Object.entries(groupedExpenses).map(([category, data]) => {
            let categoryHtml = `
                <div class="list-item main-category">
                    <span class="list-item-name">${category}</span>
                    <span class="list-item-amount">${formatCurrency(data.total)}</span>
                </div>`;
            
            if (data.items.some(item => item.subCategory)) {
                 categoryHtml += data.items.map(item => `
                    <div class="list-item sub-category">
                        <span class="list-item-name">${item.subCategory || item.category}</span>
                        <span class="list-item-amount">${formatCurrency(item.amount)}</span>
                        <button class="btn btn--secondary btn-sm edit-expense-btn" data-id="${item.id}">Edit</button>
                    </div>`
                ).join('');
            } else {
                 categoryHtml = `
                <div class="list-item main-category">
                    <span class="list-item-name">${category}</span>
                    <span class="list-item-amount">${formatCurrency(data.total)}</span>
                     <button class="btn btn--secondary btn-sm edit-expense-btn" data-id="${data.items[0].id}">Edit</button>
                </div>`;
            }

            return categoryHtml;
        }).join('');
    }
    
    // Render Totals
    if (incomeTotalEl) incomeTotalEl.innerHTML = `<span>Total Income</span><span>${formatCurrency(totalIncome)}</span>`;
    if (expenseTotalEl) expenseTotalEl.innerHTML = `<span>Total Expenses</span><span>${formatCurrency(totalExpenses)}</span>`;

    // Render Savings
    if (savingsSectionEl) {
        const savings = totalIncome - totalExpenses;
        const savingsClass = savings >= 0 ? 'text-success' : 'text-danger';
        savingsSectionEl.innerHTML = `
            <span>Savings:</span>
            <span class="${savingsClass}">${formatCurrency(savings)}</span>`;
    }
}

// --- Event Handler Functions ---

function handleAddIncome() {
    document.getElementById('incomeForm').reset();
    document.getElementById('incomeId').value = '';
    document.getElementById('incomeModalTitle').textContent = 'Add Income';
    document.getElementById('deleteIncomeBtn').style.display = 'none';
    budgetModals.income?.show();
}

function handleAddExpense() {
    document.getElementById('expenseForm').reset();
    document.getElementById('expenseId').value = '';
    document.getElementById('expenseModalTitle').textContent = 'Add Expense';
    document.getElementById('deleteExpenseBtn').style.display = 'none';
    populateCategoryDropdowns();
    budgetModals.expense?.show();
}

function handleEditIncome(button) {
    const id = parseInt(button.dataset.id);
    const budget = appState.data.budgets[0];
    const incomeItem = budget.income.find(i => i.id === id);
    if (!incomeItem) return;

    document.getElementById('incomeId').value = incomeItem.id;
    document.getElementById('incomeSource').value = incomeItem.source;
    document.getElementById('incomeAmount').value = incomeItem.amount;
    document.getElementById('incomeComments').value = incomeItem.comments;
    document.getElementById('incomeModalTitle').textContent = 'Edit Income';
    document.getElementById('deleteIncomeBtn').style.display = 'block';
    budgetModals.income?.show();
}

function handleEditExpense(button) {
    const id = parseInt(button.dataset.id);
    const budget = appState.data.budgets[0];
    const expenseItem = budget.expenses.find(e => e.id === id);
    if (!expenseItem) return;

    document.getElementById('expenseId').value = expenseItem.id;

    const [mainCat, subCat] = (expenseItem.category || '').split('-');
    populateCategoryDropdowns(mainCat, subCat);

    document.getElementById('expenseAmount').value = expenseItem.amount;
    document.getElementById('expensePayee').value = expenseItem.payee;
    document.getElementById('expenseDay').value = expenseItem.day;
    document.getElementById('expenseNotes').value = expenseItem.notes;
    document.getElementById('expenseModalTitle').textContent = 'Edit Expense';
    document.getElementById('deleteExpenseBtn').style.display = 'block';
    budgetModals.expense?.show();
}

async function handleSaveIncome() {
    const budget = appState.data.budgets[0];
    const id = parseInt(document.getElementById('incomeId').value);
    const newIncome = {
        id: id || Date.now(),
        source: document.getElementById('incomeSource').value,
        amount: parseFloat(document.getElementById('incomeAmount').value),
        comments: document.getElementById('incomeComments').value,
    };

    if (id) {
        const index = budget.income.findIndex(i => i.id === id);
        budget.income[index] = newIncome;
    } else {
        budget.income.push(newIncome);
    }

    await saveDataToFirestore();
    renderBudgetTool();
    budgetModals.income.hide();
}

async function handleSaveExpense() {
    const budget = appState.data.budgets[0];
    const id = parseInt(document.getElementById('expenseId').value);
    
    const mainCat = document.getElementById('expenseCategory').value;
    const subCat = document.getElementById('expenseSubCategory').value;
    
    let finalCategory = mainCat;
    if (subCat && subCat !== "N/A" && subCat !== "") {
        finalCategory = `${mainCat}-${subCat}`;
    }

    const newExpense = {
        id: id || Date.now(),
        category: finalCategory,
        amount: parseFloat(document.getElementById('expenseAmount').value),
        payee: document.getElementById('expensePayee').value,
        day: parseInt(document.getElementById('expenseDay').value),
        notes: document.getElementById('expenseNotes').value,
    };

    if (id) {
        const index = budget.expenses.findIndex(e => e.id === id);
        budget.expenses[index] = newExpense;
    } else {
        budget.expenses.push(newExpense);
    }
    
    await saveDataToFirestore();
    renderBudgetTool();
    budgetModals.expense.hide();
}

async function handleDeleteIncome() {
    const budget = appState.data.budgets[0];
    const id = parseInt(document.getElementById('incomeId').value);
    budget.income = budget.income.filter(i => i.id !== id);
    await saveDataToFirestore();
    renderBudgetTool();
    budgetModals.income.hide();
}

async function handleDeleteExpense() {
    const budget = appState.data.budgets[0];
    const id = parseInt(document.getElementById('expenseId').value);
    budget.expenses = budget.expenses.filter(e => e.id !== id);
    await saveDataToFirestore();
    renderBudgetTool();
    budgetModals.expense.hide();
}

async function handleSaveBudgetName() {
    const budget = appState.data.budgets[0];
    budget.name = document.getElementById('budgetName').value;
    await saveDataToFirestore();
    alert('Budget name updated!'); // Simple feedback
}

// --- Category Management Functions ---

function handleManageCategories() {
    renderCategoryManager();
    budgetModals.categoryManager?.show();
}

function renderCategoryManager() {
    const container = document.getElementById('categoryListContainer');
    const categories = appState.data.budgets[0].expenseCategories || {};
    
    container.innerHTML = Object.entries(categories).map(([mainCat, subCats]) => `
        <div class="category-manager-item">
            <div class="category-manager-header">
                <h6>${mainCat}</h6>
                <button class="btn btn-sm btn-outline-danger delete-main-category-btn" data-category="${mainCat}">&times;</button>
            </div>
            <ul class="sub-category-list">
                ${subCats.map(sub => `
                    <li class="sub-category-list-item">
                        <span>${sub}</span>
                        <button class="btn btn-sm btn-outline-danger delete-subcategory-btn" data-category="${mainCat}" data-subcategory="${sub}">&times;</button>
                    </li>
                `).join('')}
            </ul>
            <div class="input-group input-group-sm">
                <input type="text" class="form-control" placeholder="New sub-category..." id="sub-input-${mainCat.replace(/\s+/g, '')}">
                <button class="btn btn--secondary add-subcategory-btn" data-category="${mainCat}">Add</button>
            </div>
        </div>
    `).join('');
}

async function handleAddMainCategory() {
    const input = document.getElementById('newMainCategoryInput');
    const newCategory = input.value.trim();
    if (!newCategory) return;

    const budget = appState.data.budgets[0];
    if (!budget.expenseCategories[newCategory]) {
        budget.expenseCategories[newCategory] = [];
        await saveDataToFirestore();
        renderCategoryManager();
        input.value = '';
    } else {
        alert('This category already exists.');
    }
}

async function handleAddSubCategory(button) {
    const mainCategory = button.dataset.category;
    const input = document.getElementById(`sub-input-${mainCategory.replace(/\s+/g, '')}`);
    const newSubCategory = input.value.trim();
    if (!newSubCategory) return;

    const budget = appState.data.budgets[0];
    if (!budget.expenseCategories[mainCategory].includes(newSubCategory)) {
        budget.expenseCategories[mainCategory].push(newSubCategory);
        await saveDataToFirestore();
        renderCategoryManager();
    } else {
        alert('This sub-category already exists.');
    }
}

async function handleDeleteMainCategory(button) {
    const mainCategory = button.dataset.category;
    if (confirm(`Are you sure you want to delete the entire "${mainCategory}" category and all its sub-categories?`)) {
        const budget = appState.data.budgets[0];
        delete budget.expenseCategories[mainCategory];
        // Also remove expenses associated with this category
        budget.expenses = budget.expenses.filter(exp => !exp.category.startsWith(mainCategory));
        await saveDataToFirestore();
        renderCategoryManager();
        renderBudgetTool(); // Re-render main tool to remove expenses
    }
}

async function handleDeleteSubCategory(button) {
    const mainCategory = button.dataset.category;
    const subCategory = button.dataset.subcategory;
    if (confirm(`Are you sure you want to delete the sub-category "${subCategory}"?`)) {
        const budget = appState.data.budgets[0];
        budget.expenseCategories[mainCategory] = budget.expenseCategories[mainCategory].filter(s => s !== subCategory);
         // Also remove expenses associated with this sub-category
        const fullCategoryName = `${mainCategory}-${subCategory}`;
        budget.expenses = budget.expenses.filter(exp => exp.category !== fullCategoryName);
        await saveDataToFirestore();
        renderCategoryManager();
        renderBudgetTool();
    }
}


function populateCategoryDropdowns(selectedMain = '', selectedSub = '') {
    const budget = appState.data.budgets[0];
    const categories = budget.expenseCategories || {};
    const mainCategoryEl = document.getElementById('expenseCategory');

    mainCategoryEl.innerHTML = '<option value="">Select a category...</option>';
    for (const category in categories) {
        mainCategoryEl.innerHTML += `<option value="${category}" ${category === selectedMain ? 'selected' : ''}>${category}</option>`;
    }
    
    populateSubCategoryDropdown(selectedSub);
}

function populateSubCategoryDropdown(selectedSub = '') {
    const budget = appState.data.budgets[0];
    const categories = budget.expenseCategories || {};
    const mainCategoryEl = document.getElementById('expenseCategory');
    const subCategoryEl = document.getElementById('expenseSubCategory');
    const selectedMain = mainCategoryEl.value;
    
    subCategoryEl.innerHTML = '';
    
    if (selectedMain && categories[selectedMain] && categories[selectedMain].length > 0) {
        subCategoryEl.disabled = false;
        subCategoryEl.innerHTML = '<option value="">Select a sub-category...</option>';
        categories[selectedMain].forEach(sub => {
            subCategoryEl.innerHTML += `<option value="${sub}" ${sub === selectedSub ? 'selected' : ''}>${sub}</option>`;
        });
    } else {
        subCategoryEl.disabled = true;
        subCategoryEl.innerHTML = '<option value="">N/A</option>';
    }
}

