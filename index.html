<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Financial Insights - Portfolio Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- CSS styles are placed here for reliability --- */
        :root {
            --color-white: rgba(255, 255, 255, 1);
            --color-black: rgba(0, 0, 0, 1);
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-gray-400: rgba(119, 124, 124, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-brown-600: rgba(94, 82, 64, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-teal-300: rgba(50, 184, 198, 1);
            --color-teal-400: rgba(45, 166, 178, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-teal-700: rgba(26, 104, 115, 1);
            --color-teal-800: rgba(41, 150, 161, 1);
            --color-red-400: rgba(255, 84, 89, 1);
            --color-red-500: rgba(192, 21, 47, 1);
            --color-orange-400: rgba(230, 129, 97, 1);
            --color-orange-500: rgba(168, 75, 47, 1);
            --color-brown-600-rgb: 94, 82, 64;
            --color-teal-500-rgb: 33, 128, 141;
            --color-slate-900-rgb: 19, 52, 59;
            --color-slate-500-rgb: 98, 108, 113;
            --color-red-500-rgb: 192, 21, 47;
            --color-red-400-rgb: 255, 84, 89;
            --color-orange-500-rgb: 168, 75, 47;
            --color-orange-400-rgb: 230, 129, 97;
            --color-bg-1: rgba(59, 130, 246, 0.08);
            --color-bg-2: rgba(245, 158, 11, 0.08);
            --color-bg-3: rgba(34, 197, 94, 0.08);
            --color-bg-4: rgba(239, 68, 68, 0.08);
            --color-bg-5: rgba(147, 51, 234, 0.08);
            --color-bg-6: rgba(249, 115, 22, 0.08);
            --color-bg-7: rgba(236, 72, 153, 0.08);
            --color-bg-8: rgba(6, 182, 212, 0.08);
            --color-background: var(--color-cream-50);
            --color-surface: var(--color-cream-100);
            --color-text: var(--color-slate-900);
            --color-text-secondary: var(--color-slate-500);
            --color-primary: var(--color-teal-500);
            --color-primary-hover: var(--color-teal-600);
            --color-primary-active: var(--color-teal-700);
            --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
            --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
            --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
            --color-border: rgba(var(--color-brown-600-rgb), 0.2);
            --color-btn-primary-text: var(--color-cream-50);
            --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
            --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
            --color-error: var(--color-red-500);
            --color-success: var(--color-teal-500);
            --color-warning: var(--color-orange-500);
            --color-info: var(--color-slate-500);
            --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
            --color-select-caret: rgba(var(--color-slate-900-rgb), 0.8);
            --focus-ring: 0 0 0 3px var(--color-focus-ring);
            --focus-outline: 2px solid var(--color-primary);
            --status-bg-opacity: 0.15;
            --status-border-opacity: 0.25;
            --select-caret-light: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23134252' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            --select-caret-dark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23f5f5f5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            --color-success-rgb: 33, 128, 141;
            --color-error-rgb: 192, 21, 47;
            --color-warning-rgb: 168, 75, 47;
            --color-info-rgb: 98, 108, 113;
            --font-family-base: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --font-family-mono: "Berkeley Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            --font-size-xs: 11px;
            --font-size-sm: 12px;
            --font-size-base: 14px;
            --font-size-md: 14px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            --font-size-2xl: 20px;
            --font-size-3xl: 24px;
            --font-size-4xl: 30px;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 550;
            --font-weight-bold: 600;
            --line-height-tight: 1.2;
            --line-height-normal: 1.5;
            --letter-spacing-tight: -0.01em;
            --space-0: 0;
            --space-1: 1px;
            --space-2: 2px;
            --space-4: 4px;
            --space-6: 6px;
            --space-8: 8px;
            --space-10: 10px;
            --space-12: 12px;
            --space-16: 16px;
            --space-20: 20px;
            --space-24: 24px;
            --space-32: 32px;
            --radius-sm: 6px;
            --radius-base: 8px;
            --radius-md: 10px;
            --radius-lg: 12px;
            --radius-full: 9999px;
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.02);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
            --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.15), inset 0 -1px 0 rgba(0, 0, 0, 0.03);
            --duration-fast: 150ms;
            --duration-normal: 250ms;
            --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);
            --container-sm: 640px;
            --container-md: 768px;
            --container-lg: 1024px;
            --container-xl: 1280px;
        }
        html { font-size: var(--font-size-base); font-family: var(--font-family-base); line-height: var(--line-height-normal); color: var(--color-text); background-color: var(--color-background); -webkit-font-smoothing: antialiased; box-sizing: border-box; }
        body { margin: 0; padding: 0; }
        *, *::before, *::after { box-sizing: inherit; }
        h1, h2, h3, h4, h5, h6 { margin: 0; font-weight: var(--font-weight-semibold); line-height: var(--line-height-tight); color: var(--color-text); letter-spacing: var(--letter-spacing-tight); }
        h1 { font-size: var(--font-size-4xl); } h2 { font-size: var(--font-size-3xl); } h3 { font-size: var(--font-size-2xl); } h4 { font-size: var(--font-size-xl); } h5 { font-size: var(--font-size-lg); } h6 { font-size: var(--font-size-md); }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: var(--space-8) var(--space-16); border-radius: var(--radius-base); font-size: var(--font-size-base); font-weight: 500; line-height: 1.5; cursor: pointer; transition: all var(--duration-normal) var(--ease-standard); border: none; text-decoration: none; position: relative; }
        .btn:focus-visible { outline: none; box-shadow: var(--focus-ring); }
        .btn--primary { background: var(--color-primary); color: var(--color-btn-primary-text); }
        .btn--primary:hover { background: var(--color-primary-hover); }
        .btn--primary:active { background: var(--color-primary-active); }
        .btn--secondary { background: var(--color-secondary); color: var(--color-text); }
        .btn--secondary:hover { background: var(--color-secondary-hover); }
        .btn--secondary:active { background: var(--color-secondary-active); }
        .btn--outline { background: transparent; border: 1px solid var(--color-border); color: var(--color-text); }
        .btn--outline:hover { background: var(--color-secondary); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .form-control, .form-select { display: block; width: 100%; padding: var(--space-8) var(--space-12); font-size: var(--font-size-md); line-height: 1.5; color: var(--color-text); background-color: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-base); transition: border-color var(--duration-fast) var(--ease-standard), box-shadow var(--duration-fast) var(--ease-standard); }
        select.form-control, select.form-select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: var(--select-caret-light); background-repeat: no-repeat; background-position: right var(--space-12) center; background-size: 16px; padding-right: var(--space-32); }
        .form-control:focus, .form-select:focus { border-color: var(--color-primary); outline: 0; box-shadow: var(--focus-ring); }
        .form-label { display: block; margin-bottom: var(--space-8); font-weight: var(--font-weight-medium); font-size: var(--font-size-sm); }
        .form-group { margin-bottom: var(--space-16); }
        .form-check-input:checked { background-color: var(--color-primary); border-color: var(--color-primary); }
        .form-check-label { font-size: var(--font-size-base); }
        .card { background-color: var(--color-surface); border-radius: var(--radius-lg); border: 1px solid var(--color-card-border); box-shadow: var(--shadow-sm); overflow: hidden; transition: box-shadow var(--duration-normal) var(--ease-standard); }
        .card:hover { box-shadow: var(--shadow-md); }
        .card-body, .card__body { padding: var(--space-20); }
        .card-header, .card__header { padding: var(--space-16) var(--space-20); border-bottom: 1px solid var(--color-card-border-inner); }
        .app-container { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background: var(--color-surface); border-right: 1px solid var(--color-border); position: fixed; top: 0; left: 0; height: 100vh; z-index: 1000; transition: transform var(--duration-normal) var(--ease-standard); overflow-y: auto; }
        .sidebar-header { padding: var(--space-24) var(--space-20); border-bottom: 1px solid var(--color-border); }
        .sidebar-header h4 { margin: 0; color: var(--color-primary); font-weight: var(--font-weight-bold); font-size: var(--font-size-xl); }
        .nav-links { list-style: none; padding: var(--space-16) 0; margin: 0; }
        .nav-links li { margin-bottom: var(--space-4); }
        .nav-link { display: flex; align-items: center; padding: var(--space-12) var(--space-20); color: var(--color-text-secondary); text-decoration: none; transition: all var(--duration-fast) var(--ease-standard); border-left: 3px solid transparent; }
        .nav-link:hover { background-color: var(--color-secondary); color: var(--color-text); text-decoration: none; }
        .nav-link.active { background-color: var(--color-secondary); color: var(--color-primary); border-left-color: var(--color-primary); }
        .nav-link i { width: 20px; margin-right: var(--space-12); }
        .mobile-menu-btn { position: fixed; top: var(--space-16); left: var(--space-16); z-index: 1001; background: var(--color-primary); color: var(--color-btn-primary-text); border: none; padding: var(--space-8) var(--space-12); border-radius: var(--radius-base); transition: all var(--duration-fast) var(--ease-standard); }
        .main-content { flex: 1; margin-left: 260px; padding: var(--space-24); background: var(--color-background); height: 100vh; overflow-y: auto; overflow-x: auto; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .section-header { margin-bottom: var(--space-32); }
        .section-header h2 { margin-bottom: var(--space-8); color: var(--color-text); }
        .metric-card { border: 1px solid var(--color-card-border); transition: all var(--duration-normal) var(--ease-standard); height: 100%; }
        .metric-card:hover { box-shadow: var(--shadow-lg); transform: translateY(-2px); }
        .metric-icon { width: 48px; height: 48px; border-radius: var(--radius-base); display: flex; align-items: center; justify-content: center; color: white; }
        .metric-icon.bg-primary { background: var(--color-primary); }
        .metric-icon.bg-success { background: var(--color-success); }
        .metric-icon.bg-info { background: var(--color-info); }
        .table { margin-bottom: 0; }
        .table th { background-color: var(--color-bg-1); border-top: none; font-weight: var(--font-weight-semibold); color: var(--color-text); font-size: var(--font-size-sm); padding: var(--space-12) var(--space-16); }
        .table td { padding: var(--space-12) var(--space-16); vertical-align: middle; border-color: var(--color-border); }
        .table-hover tbody tr:hover { background-color: var(--color-bg-1); color: var(--color-text); }
        .asset-symbol-link { font-weight: var(--font-weight-bold); color: var(--color-primary); cursor: pointer; text-decoration: none; }
        .asset-symbol-link:hover { text-decoration: underline; }
        .gain-positive { color: var(--color-success) !important; font-weight: var(--font-weight-medium); }
        .gain-negative { color: var(--color-error) !important; font-weight: var(--font-weight-medium); }
        .insight-card { background: var(--color-surface); border: 1px solid var(--color-card-border); border-radius: var(--radius-lg); padding: var(--space-20); transition: all var(--duration-normal) var(--ease-standard); height: 100%; }
        .insight-card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
        .insight-header { display: flex; align-items: center; margin-bottom: var(--space-12); }
        .insight-icon { width: 40px; height: 40px; border-radius: var(--radius-base); display: flex; align-items: center; justify-content: center; margin-right: var(--space-12); color: white; }
        .insight-icon.rebalance { background: var(--color-warning); }
        .insight-icon.performance { background: var(--color-success); }
        .insight-icon.risk { background: var(--color-info); }
        .insight-icon.opportunity { background: var(--color-teal-400); }
        .insight-icon.news { background: var(--color-slate-500); }
        .insight-title { font-weight: var(--font-weight-semibold); color: var(--color-text); margin: 0; }
        .insight-description { color: var(--color-text-secondary); margin: 0; line-height: var(--line-height-normal); }
        .modal-content { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-lg); }
        .modal-header { background: var(--color-bg-3); border-bottom: 1px solid var(--color-border); }
        .modal-title { color: var(--color-text); font-weight: var(--font-weight-semibold); }
        .modal-body { max-height: 70vh; overflow-y: auto; }
        .empty-state { text-align: center; padding: 4rem 2rem; background: var(--color-surface); border-radius: var(--radius-lg); }
        .empty-state i { font-size: 4rem; color: var(--color-primary); margin-bottom: 1.5rem; }
        .empty-state h4 { font-weight: 600; margin-bottom: 0.5rem; }
        .empty-state p { color: var(--color-text-secondary); margin-bottom: 1.5rem; }
        #companyInfoCard, #editAssetInfoCard { background-color: var(--color-bg-1); border: 1px solid var(--color-border); }
        .alert-success { color: var(--color-success); background-color: var(--color-bg-3); border-color: var(--color-success); }
        .badge.bg-buy { background-color: var(--color-bg-3) !important; color: var(--color-success) !important; border: 1px solid var(--color-success); }
        .badge.bg-sell { background-color: var(--color-bg-4) !important; color: var(--color-error) !important; border: 1px solid var(--color-error); }
        .badge.bg-hold { background-color: var(--color-bg-2) !important; color: var(--color-warning) !important; border: 1px solid var(--color-warning); }
        .badge.bg-dividend { background-color: var(--color-bg-1) !important; color: var(--color-info) !important; }
        
        #auth-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .auth-card { max-width: 400px; width: 100%; }
        .app-wrapper.logged-out .app-container { display: none; }
        .app-wrapper.logged-in #auth-container { display: none; }

        .spinner-container { display: flex; justify-content: center; align-items: center; height: 200px; }

        @media (max-width: 991.98px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.show { transform: translateX(0); }
            .main-content { margin-left: 0; padding: var(--space-16); padding-top: 70px; }
            .mobile-menu-btn { display: block !important; }
        }
        @media (min-width: 992px) { .mobile-menu-btn { display: none; } }
    </style>
</head>
<body>
    <div class="app-wrapper">
        <div id="auth-container">
            <div class="card auth-card">
                <div class="card-body">
                    <h3 class="text-center mb-4"><i class="fas fa-chart-pie me-2"></i>AI Finance</h3>
                    <div id="auth-view">
                        <form id="loginForm">
                            <h5 class="mb-3">Login</h5>
                            <div id="login-error" class="alert alert-danger d-none"></div>
                            <div class="form-group">
                                <label for="loginEmail" class="form-label">Email</label>
                                <input type="email" id="loginEmail" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="loginPassword" class="form-label">Password</label>
                                <div class="input-group">
                                    <input type="password" id="loginPassword" class="form-control" required>
                                    <button class="btn btn-outline-secondary" type="button" id="toggleLoginPassword">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                            <button type="submit" class="btn btn--primary w-100 mt-3">Login</button>
                            <p class="text-center mt-3 mb-0">
                                Don't have an account? <a href="#" id="show-signup">Sign Up</a>
                            </p>
                        </form>

                        <form id="signupForm" class="d-none">
                            <h5 class="mb-3">Create Account</h5>
                             <div id="signup-error" class="alert alert-danger d-none"></div>
                            <div class="form-group">
                                <label for="signupEmail" class="form-label">Email</label>
                                <input type="email" id="signupEmail" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="signupPassword" class="form-label">Password</label>
                                <div class="input-group">
                                    <input type="password" id="signupPassword" class="form-control" required>
                                    <button class="btn btn-outline-secondary" type="button" id="toggleSignupPassword">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                            <button type="submit" class="btn btn--primary w-100 mt-3">Sign Up</button>
                            <p class="text-center mt-3 mb-0">
                                Already have an account? <a href="#" id="show-login">Login</a>
                            </p>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="app-container">
            <nav id="sidebar" class="sidebar">
                <div class="sidebar-header">
                    <h4><i class="fas fa-chart-pie me-2"></i>AI Finance</h4>
                </div>
                <ul class="nav-links">
                    <li><a href="#" class="nav-link active" data-section="dashboard"><i class="fas fa-tachometer-alt"></i>Dashboard</a></li>
                    <li><a href="#" class="nav-link" data-section="portfolio"><i class="fas fa-wallet"></i>Portfolio</a></li>
                    <li><a href="#" class="nav-link" data-section="insights"><i class="fas fa-brain"></i>AI Insights</a></li>
                    <li><a href="#" class="nav-link" data-section="preferences"><i class="fas fa-sliders-h"></i>Preferences</a></li>
                     <li><a href="#" class="nav-link d-none" data-section="asset-profile"><i class="fas fa-chart-bar"></i>Asset Profile</a></li>
                </ul>
                 <div class="mt-auto p-3">
                    <button class="btn btn--secondary w-100" id="signOutBtn"><i class="fas fa-sign-out-alt me-2"></i>Sign Out</button>
                </div>
            </nav>

            <button class="mobile-menu-btn d-lg-none" id="mobileMenuBtn">
                <i class="fas fa-bars"></i>
            </button>

            <main class="main-content">
                <section id="dashboard" class="content-section active">
                    <div class="section-header">
                        <h2>Portfolio Dashboard</h2>
                        <p class="text-secondary" id="dashboard-portfolio-name">A real-time overview of your investment portfolio.</p>
                    </div>
                    <div id="dashboardContent">
                        </div>
                </section>

                <section id="portfolio" class="content-section">
                     <div class="section-header">
                        <h2>Portfolio Management</h2>
                        <p class="text-secondary">Detailed view of your current holdings.</p>
                    </div>
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-3">
                                <div class="d-flex align-items-center gap-2">
                                    <label for="portfolioSelector" class="form-label mb-0">Active Portfolio:</label>
                                    <select id="portfolioSelector" class="form-select" style="width: auto;"></select>
                                     <button class="btn btn-sm btn--secondary" id="editPortfolioNameBtn" title="Edit portfolio name">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn--outline" id="createPortfolioBtn">
                                        <i class="fas fa-plus me-2"></i>Create New
                                    </button>
                                    <button class="btn btn--primary" id="addInvestmentBtnPortfolio">
                                        <i class="fas fa-plus me-2"></i>Add Investment
                                    </button>
                                </div>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-end align-items-center flex-wrap gap-2 pt-2">
                                <button class="btn btn-sm btn--outline" id="updatePricesBtn">
                                    <i class="fas fa-dollar-sign me-2"></i>Update Prices
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="portfolioContent">
                         </div>
                </section>
                
                <section id="asset-profile" class="content-section">
                    <div id="assetProfileContent">
                        </div>
                </section>

                <section id="insights" class="content-section">
                    <div class="section-header">
                        <h2>AI Insights</h2>
                        <p class="text-secondary">Automated recommendations and analysis powered by AI.</p>
                    </div>
                     <div class="d-flex gap-2 mb-4">
                        <button class="btn btn--primary" id="generateInsightsBtn">
                            <i class="fas fa-wand-magic-sparkles me-2"></i>✨ Analyze My Portfolio
                        </button>
                        <button class="btn btn--secondary" id="getNewsAnalysisBtn">
                            <i class="fas fa-newspaper me-2"></i>✨ Get Market News Analysis
                        </button>
                    </div>
                    <div id="insightsContainer" class="row">
                        </div>
                </section>
                
                <section id="preferences" class="content-section">
                    <div class="section-header">
                        <h2>User Preferences</h2>
                        <p class="text-secondary">Customize your risk profile and goals to tailor AI suggestions.</p>
                    </div>
                    <div class="card">
                        <div class="card__body">
                            <form id="preferencesForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="riskTolerance" class="form-label">Risk Tolerance</label>
                                            <div class="input-group">
                                                <select id="riskTolerance" class="form-select">
                                                    <option value="Low">Low</option>
                                                    <option value="Moderate" selected>Moderate</option>
                                                    <option value="High">High</option>
                                                </select>
                                                <button class="btn btn--outline" type="button" id="openQuestionnaireBtn">
                                                    <i class="fas fa-tasks me-2"></i>AI Assess
                                                </button>
                                            </div>
                                            <div id="riskAnalysisResult" class="form-text mt-2"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="investmentCapital" class="form-label">Total Available Investment Capital</label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="number" class="form-control" id="investmentCapital" placeholder="e.g., 50000">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <hr class="my-4">
                                
                                <div class="form-group">
                                    <label class="form-label">Sub-Investment Goals</label>
                                    <div id="subInvestmentGoals" class="d-flex flex-wrap gap-3">
                                        <div class="form-check"><input class="form-check-input" type="checkbox" value="Long-term Growth" id="subGoalGrowth"><label class="form-check-label" for="subGoalGrowth">Long-term Growth</label></div>
                                        <div class="form-check"><input class="form-check-input" type="checkbox" value="Short-term Income" id="subGoalIncome"><label class="form-check-label" for="subGoalIncome">Short-term Income</label></div>
                                        <div class="form-check"><input class="form-check-input" type="checkbox" value="Passive Dividend Income" id="subGoalDividend"><label class="form-check-label" for="subGoalDividend">Passive Dividend Income</label></div>
                                        <div class="form-check"><input class="form-check-input" type="checkbox" value="Capital Preservation" id="goalPreservation"><label class="form-check-label" for="goalPreservation">Capital Preservation</label></div>
                                    </div>
                                </div>
                                
                                <hr class="my-4">

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">Preferred or Excluded Asset Classes</label>
                                            <div id="assetClassPrefs">
                                                </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">Industry/Sector Preferences</label>
                                            <div id="sectorPrefs">
                                                </div>
                                        </div>
                                    </div>
                                </div>

                                <hr class="my-4">

                                <div class="form-group">
                                    <label class="form-label">Tax Considerations</label>
                                    <div id="taxConsiderations" class="d-flex flex-wrap gap-3">
                                        <div class="form-check"><input class="form-check-input" type="checkbox" value="Tax-loss Harvesting" id="taxHarvesting"><label class="form-check-label" for="taxHarvesting">Tax-loss Harvesting</label></div>
                                        <div class="form-check"><input class="form-check-input" type="checkbox" value="Tax Avoidance" id="taxAvoidance"><label class="form-check-label" for="taxAvoidance">Tax Avoidance</label></div>
                                        <div class="form-check"><input class="form-check-input" type="checkbox" value="Liquidity Needs" id="taxLiquidity"><label class="form-check-label" for="taxLiquidity">Liquidity Needs</label></div>
                                    </div>
                                </div>

                                <button type="submit" class="btn btn--primary mt-3">Save Preferences</button>
                            </form>
                            <div id="preferencesMessage" class="mt-3"></div>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <div class="modal fade" id="riskQuestionnaireModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Investor Risk Tolerance Questionnaire</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="riskQuestionnaireForm">
                        <h6>1. Personal and Financial Situation</h6>
                        <div class="mb-3">
                            <label class="form-label">1.1 What is your age?</label>
                            <div>
                                <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="q1_1" value="Under 30"><label class="form-check-label">Under 30</label></div>
                                <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="q1_1" value="30-39"><label class="form-check-label">30-39</label></div>
                                <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="q1_1" value="40-49"><label class="form-check-label">40-49</label></div>
                                <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="q1_1" value="50-59"><label class="form-check-label">50-59</label></div>
                                <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="q1_1" value="60 or older"><label class="form-check-label">60 or older</label></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">1.2 What is your primary source of income?</label>
                            <div>
                                <div class="form-check"><input class="form-check-input" type="radio" name="q1_2" value="Full-time employment"><label class="form-check-label">Full-time employment</label></div>
                                <div class="form-check"><input class="form-check-input" type="radio" name="q1_2" value="Part-time employment"><label class="form-check-label">Part-time employment</label></div>
                                <div class="form-check"><input class="form-check-input" type="radio" name="q1_2" value="Self-employment"><label class="form-check-label">Self-employment</label></div>
                                <div class="form-check"><input class="form-check-input" type="radio" name="q1_2" value="Retirement income"><label class="form-check-label">Retirement income</label></div>
                                <div class="form-check"><input class="form-check-input" type="radio" name="q1_2" value="Investment income"><label class="form-check-label">Investment income</label></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">1.3 How would you describe the stability of your income?</label>
                            <div>
                                <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="q1_3" value="Very stable"><label class="form-check-label">Very stable</label></div>
                                <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="q1_3" value="Somewhat stable"><label class="form-check-label">Somewhat stable</label></div>
                                <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="q1_3" value="Unstable"><label class="form-check-label">Unstable</label></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">1.4 Do you currently have an emergency fund?</label>
                            <div>
                                <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="q1_4" value="Yes, more than 6 months"><label class="form-check-label">Yes, >6 months</label></div>
                                <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="q1_4" value="Yes, 3-6 months"><label class="form-check-label">Yes, 3-6 months</label></div>
                                <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="q1_4" value="Yes, less than 3 months"><label class="form-check-label">Yes, <3 months</label></div>
                                <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="q1_4" value="No"><label class="form-check-label">No</label></div>
                            </div>
                        </div>

                        <hr>
                        <h6>2. Investment Objectives</h6>
                        <div class="mb-3">
                            <label class="form-label">2.1 What is your investment time horizon?</label>
                            <div>
                                <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="q2_1" value="Less than 3 years"><label class="form-check-label"><3 years</label></div>
                                <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="q2_1" value="3-5 years"><label class="form-check-label">3-5 years</label></div>
                                <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="q2_1" value="6-10 years"><label class="form-check-label">6-10 years</label></div>
                                <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="q2_1" value="More than 10 years"><label class="form-check-label">>10 years</label></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">2.2 Will you need access to these funds in the short term?</label>
                            <div>
                                <div class="form-check"><input class="form-check-input" type="radio" name="q2_2" value="Yes, within the next year"><label class="form-check-label">Yes, within the next year</label></div>
                                <div class="form-check"><input class="form-check-input" type="radio" name="q2_2" value="Possibly, within the next 1-3 years"><label class="form-check-label">Possibly, within the next 1-3 years</label></div>
                                <div class="form-check"><input class="form-check-input" type="radio" name="q2_2" value="Unlikely, I won't need them for more than 3 years"><label class="form-check-label">Unlikely, I won't need them for more than 3 years</label></div>
                            </div>
                        </div>

                        <hr>
                        <h6>3. Behavioral Questions</h6>
                        <div class="mb-3">
                            <label class="form-label">3.1 How would you feel if your investment dropped 10% in a month?</label>
                            <div>
                                <div class="form-check"><input class="form-check-input" type="radio" name="q3_1" value="Very concerned, I'd consider selling"><label class="form-check-label">Very concerned, I'd consider selling</label></div>
                                <div class="form-check"><input class="form-check-input" type="radio" name="q3_1" value="Slightly concerned, I'd watch closely"><label class="form-check-label">Slightly concerned, I'd watch closely</label></div>
                                <div class="form-check"><input class="form-check-input" type="radio" name="q3_1" value="Not concerned, I understand volatility"><label class="form-check-label">Not concerned, I understand volatility</label></div>
                                <div class="form-check"><input class="form-check-input" type="radio" name="q3_1" value="I'd consider investing more"><label class="form-check-label">I'd consider investing more</label></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">3.2 If your portfolio dropped 20% in a year, what would you most likely do?</label>
                             <div>
                                <div class="form-check"><input class="form-check-input" type="radio" name="q3_2" value="Sell everything to avoid further losses"><label class="form-check-label">Sell everything to avoid further losses</label></div>
                                <div class="form-check"><input class="form-check-input" type="radio" name="q3_2" value="Sell some investments"><label class="form-check-label">Sell some investments</label></div>
                                <div class="form-check"><input class="form-check-input" type="radio" name="q3_2" value="Hold steady and wait for recovery"><label class="form-check-label">Hold steady and wait for recovery</label></div>
                                <div class="form-check"><input class="form-check-input" type="radio" name="q3_2" value="Invest more because of lower prices"><label class="form-check-label">Invest more because of lower prices</label></div>
                            </div>
                        </div>

                        <hr>
                        <h6>4. Hypothetical Scenarios</h6>
                        <div class="mb-3">
                            <label class="form-label">4.1 Which portfolio would you be most comfortable with?</label>
                            <div>
                                <div class="form-check"><input class="form-check-input" type="radio" name="q4_1" value="A: Avg return 4%, worst year -2%"><label class="form-check-label">A: Avg return 4%, worst year -2%</label></div>
                                <div class="form-check"><input class="form-check-input" type="radio" name="q4_1" value="B: Avg return 6%, worst year -10%"><label class="form-check-label">B: Avg return 6%, worst year -10%</label></div>
                                <div class="form-check"><input class="form-check-input" type="radio" name="q4_1" value="C: Avg return 8%, worst year -20%"><label class="form-check-label">C: Avg return 8%, worst year -20%</label></div>
                                <div class="form-check"><input class="form-check-input" type="radio" name="q4_1" value="D: Avg return 10%, worst year -30%"><label class="form-check-label">D: Avg return 10%, worst year -30%</label></div>
                            </div>
                        </div>

                        <hr>
                        <h6>5. Risk-Reward Trade-Off</h6>
                        <div class="mb-3">
                            <label class="form-label">5.1 How much risk are you willing to take to meet your financial goals?</label>
                            <div>
                                <div class="form-check"><input class="form-check-input" type="radio" name="q5_1" value="None, I want to preserve capital"><label class="form-check-label">None, I want to preserve capital</label></div>
                                <div class="form-check"><input class="form-check-input" type="radio" name="q5_1" value="Low, I prefer safety but can accept small losses"><label class="form-check-label">Low, I prefer safety but can accept small losses</label></div>
                                <div class="form-check"><input class="form-check-input" type="radio" name="q5_1" value="Moderate, I'm okay with ups and downs for better long-term returns"><label class="form-check-label">Moderate, I'm okay with ups and downs for better long-term returns</label></div>
                                <div class="form-check"><input class="form-check-input" type="radio" name="q5_1" value="High, I want the highest possible return and accept large short-term losses"><label class="form-check-label">High, I want the highest possible return and accept large short-term losses</label></div>
                            </div>
                        </div>
                         <div class="mb-3">
                            <label class="form-label">5.2 Are you more concerned about...</label>
                            <div>
                                <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="q5_2" value="Losing money"><label class="form-check-label">Losing money</label></div>
                                <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="q5_2" value="Missing out on gains"><label class="form-check-label">Missing out on gains</label></div>
                                <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="q5_2" value="Both equally"><label class="form-check-label">Both equally</label></div>
                            </div>
                        </div>

                        <hr>
                        <h6>6. Experience and Knowledge</h6>
                        <div class="mb-3">
                            <label class="form-label">6.1 Have you invested before?</label>
                            <div>
                                <div class="form-check"><input class="form-check-input" type="radio" name="q6_1" value="Yes, in a variety of assets (stocks, bonds, real estate, etc.)"><label class="form-check-label">Yes, in a variety of assets (stocks, bonds, real estate, etc.)</label></div>
                                <div class="form-check"><input class="form-check-input" type="radio" name="q6_1" value="Yes, but only in basic accounts (savings, CDs)"><label class="form-check-label">Yes, but only in basic accounts (savings, CDs)</label></div>
                                <div class="form-check"><input class="form-check-input" type="radio" name="q6_1" value="No, I'm new to investing"><label class="form-check-label">No, I'm new to investing</label></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">6.2 How familiar are you with different types of investments?</label>
                            <div>
                                <div class="form-check"><input class="form-check-input" type="radio" name="q6_2" value="Very familiar – I regularly invest in different assets"><label class="form-check-label">Very familiar – I regularly invest in different assets</label></div>
                                <div class="form-check"><input class="form-check-input" type="radio" name="q6_2" value="Somewhat familiar – I know the basics"><label class="form-check-label">Somewhat familiar – I know the basics</label></div>
                                <div class="form-check"><input class="form-check-input" type="radio" name="q6_2" value="Not very familiar – I rely on others or do minimal investing"><label class="form-check-label">Not very familiar – I rely on others or do minimal investing</label></div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn--secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn--primary" id="submitQuestionnaireBtn">Submit for Analysis</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="investmentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="investmentModalTitle">Add New Investment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>You are adding a new investment to the '<strong id="modalPortfolioName"></strong>' portfolio. Please enter the details of your first purchase.</p>
                    <form id="investmentForm">
                        <div class="form-group mb-3">
                            <label class="form-label">Symbol</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="investmentSymbol" required placeholder="e.g., AAPL, BTC-USD">
                                <button class="btn btn--outline" type="button" id="getAssetInfoBtn">
                                    <i class="fas fa-info-circle me-1"></i> Get Asset Info
                                </button>
                            </div>
                        </div>
                        <div id="companyInfoCard" class="card p-3 mb-3 d-none">
                            <div id="companyInfoContent"></div>
                        </div>
                        <div class="form-group mb-3">
                            <label class="form-label">Asset Name</label>
                            <input type="text" class="form-control" id="investmentName" required placeholder="e.g., Apple Inc. or Bitcoin">
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">Shares</label>
                                    <input type="number" step="any" class="form-control" id="investmentShares" required placeholder="e.g., 10">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">Purchase Price</label>
                                    <input type="number" step="0.01" class="form-control" id="investmentPrice" required placeholder="e.g., 150.25">
                                </div>
                            </div>
                        </div>
                         <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">Purchase Date</label>
                                    <input type="date" class="form-control" id="investmentDate" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">Asset Type</label>
                                    <select class="form-select" id="investmentType" required>
                                        <option value="Stock">Stock</option>
                                        <option value="ETF">ETF</option>
                                        <option value="Bond">Bond</option>
                                        <option value="Crypto">Cryptocurrency</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn--secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn--primary" id="saveInvestmentBtn">Save Investment</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editAssetModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Asset Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editAssetForm">
                        <input type="hidden" id="editAssetId">
                        <div class="form-group mb-3">
                            <label class="form-label">Symbol</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="editAssetSymbol" required>
                                <button class="btn btn--outline" type="button" id="getAssetInfoBtnEdit">
                                    <i class="fas fa-info-circle me-1"></i> Get Asset Info
                                </button>
                            </div>
                        </div>
                        <div id="editAssetInfoCard" class="card p-3 mb-3 d-none">
                            <div id="editAssetInfoContent"></div>
                        </div>
                        <div class="form-group mb-3">
                            <label class="form-label">Asset Name</label>
                            <input type="text" class="form-control" id="editAssetName" required>
                        </div>
                        <div class="form-group mb-3">
                            <label class="form-label">Asset Type</label>
                            <select class="form-select" id="editAssetType" required>
                                <option value="Stock">Stock</option>
                                <option value="ETF">ETF</option>
                                <option value="Bond">Bond</option>
                                <option value="Crypto">Cryptocurrency</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn--secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn--primary" id="saveAssetEditBtn">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="transactionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="transactionModalTitle">Manage Transactions</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-5">
                            <h6 class="mb-3">Add New Transaction</h6>
                            <form id="transactionForm">
                                <input type="hidden" id="transactionHoldingId">
                                <div class="form-group">
                                    <label for="transactionType" class="form-label">Type</label>
                                    <select id="transactionType" class="form-select">
                                        <option value="Buy" selected>Buy</option>
                                        <option value="Sell">Sell</option>
                                        <option value="Dividend">Dividend</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="transactionDate" class="form-label">Date</label>
                                    <input type="date" id="transactionDate" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="transactionShares" class="form-label">Quantity / Shares</label>
                                    <input type="number" step="any" id="transactionShares" class="form-control" placeholder="e.g., 5">
                                </div>
                                <div class="form-group">
                                    <label for="transactionPrice" class="form-label">Price per Share</label>
                                    <input type="number" step="0.01" id="transactionPrice" class="form-control" placeholder="e.g., 175.50">
                                </div>
                                <div class="d-flex gap-2 mt-2">
                                    <button type="submit" class="btn btn--primary w-100">Add Transaction</button>
                                    <button type="button" class="btn btn--secondary w-100" data-bs-dismiss="modal">Done</button>
                                </div>
                            </form>
                        </div>
                        <div class="col-md-7">
                            <h6 class="mb-3">Transaction History for <span id="transactionHistorySymbol"></span></h6>
                            <div id="transactionHistoryContainer" style="max-height: 300px; overflow-y: auto;">
                                </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="portfolioModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="portfolioModalTitle">Create New Portfolio</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="portfolioForm">
                        <input type="hidden" id="editPortfolioId">
                        <div class="form-group">
                            <label for="portfolioName" class="form-label">Portfolio Name</label>
                            <input type="text" id="portfolioName" class="form-control" placeholder="e.g., Retirement Fund" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn--secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn--primary" id="savePortfolioBtn">Save</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this holding and all its transactions? This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn--secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script type="module">
        // Firebase v9+ modular SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // --- CONFIGURATION & KEYS --- //
        // This is where your deployment script will replace the placeholders.
        const firebaseConfig = {
            apiKey: "AIzaSyCWLNOrUwyj1VKajaUi5M74AnAL75c3p_M",
            authDomain: "financial-insights-app.firebaseapp.com",
            projectId: "financial-insights-app",
            storageBucket: "financial-insights-app.appspot.com",
            messagingSenderId: "436668403248",
            appId: "1:436668403248:web:c52797f37c053f1ab327f5",
            measurementId: "G-3NYHCJ4RT8"
        };
        const finnhubApiKey = "d27bc81r01qloaribsbgd27bc81r01qloaribsc0";
        const alphaVantageApiKey = "656EPSSG2VEQKVSH";
        
        // --- INITIALIZATION --- //
        // We wrap the entire application logic in a function that runs after the DOM is ready.
        function main() {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            // --- STATE MANAGEMENT --- //
            let appData = {};
            let currentUserId = null;
            let unsubscribeFromFirestore = null;
            let holdingIdToModify = null;
            const PREF_DEFAULTS = {
                assetClasses: ["Stock", "ETF", "Bond", "Crypto", "Mutual Fund", "Other"],
                sectors: ["Technology", "Healthcare", "Financials", "Consumer Discretionary", "Industrials", "Green Energy", "No Fossil Fuels"]
            };

            const initialData = {
                user_profile: {
                    name: "New User",
                    risk_tolerance: "Moderate",
                    investment_goals: ["Wealth Building"],
                    available_capital: 50000,
                    sub_goals: ["Long-term Growth"],
                    asset_preferences: { preferred: ["Stock", "ETF"], excluded: [] },
                    sector_preferences: { preferred: ["Technology", "Green Energy"], excluded: ["Fossil Fuels"] },
                    tax_considerations: ["Tax-loss Harvesting"],
                },
                portfolios: [
                    {
                        id: Date.now(),
                        name: "My First Portfolio",
                        holdings: [],
                        transactions: [],
                    }
                ],
                activePortfolioId: null,
                insights: [
                    {
                        type: "opportunity",
                        title: "Welcome to AI Finance!",
                        description: "Add your first investment to see your portfolio dashboard and generate personalized AI insights."
                    }
                ]
            };
            initialData.activePortfolioId = initialData.portfolios[0].id;

            // --- DOM ELEMENTS --- //
            const appWrapper = document.querySelector('.app-wrapper');
            const sidebar = document.getElementById('sidebar');
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const navLinks = document.querySelectorAll('.nav-link');
            const contentSections = document.querySelectorAll('.content-section');
            
            // Modals
            const investmentModalEl = document.getElementById('investmentModal');
            const investmentModal = new bootstrap.Modal(investmentModalEl);
            const editAssetModalEl = document.getElementById('editAssetModal');
            const editAssetModal = new bootstrap.Modal(editAssetModalEl);
            const transactionModalEl = document.getElementById('transactionModal');
            const transactionModal = new bootstrap.Modal(transactionModalEl);
            const portfolioModalEl = document.getElementById('portfolioModal');
            const portfolioModal = new bootstrap.Modal(portfolioModalEl);
            const deleteConfirmModalEl = document.getElementById('deleteConfirmModal');
            const deleteConfirmModal = new bootstrap.Modal(deleteConfirmModalEl);
            const riskQuestionnaireModalEl = document.getElementById('riskQuestionnaireModal');
            const riskQuestionnaireModal = new bootstrap.Modal(riskQuestionnaireModalEl);

            // --- CHARTS --- //
            let allocationChart = null;
            let performanceChart = null;
            Chart.register(ChartDataLabels);
            
            // --- APP LOGIC --- //
            function init() {
                initializeAuth();
                initializeNavigation();
                initializeEventListeners();
            }

            async function renderAll() {
                await renderDashboard(); // Now async
                renderPortfolioSelector();
                renderPortfolio();
                renderInsights();
                renderPreferences();
            }

            // --- DATA PERSISTENCE (FIRESTORE) --- //
            function deepMerge(target, source) {
                for (const key in source) {
                    if (source[key] instanceof Object && key in target && !(source[key] instanceof Array)) {
                        target[key] = deepMerge(target[key], source[key]);
                    } else {
                        target[key] = source[key];
                    }
                }
                return target;
            }

            function loadDataFromFirestore(userId) {
                if (unsubscribeFromFirestore) {
                    unsubscribeFromFirestore();
                }
                const userDocRef = doc(db, "users", userId);
                
                unsubscribeFromFirestore = onSnapshot(userDocRef, async (docSnap) => { // onSnapshot callback is now async
                    if (docSnap.exists()) {
                        const loadedData = docSnap.data();
                        appData = deepMerge(JSON.parse(JSON.stringify(initialData)), loadedData);
                        await renderAll(); // await the async render function
                    } else {
                        appData = JSON.parse(JSON.stringify(initialData));
                        setDoc(userDocRef, appData).then(async () => {
                            await renderAll();
                        });
                    }
                });
            }

            async function saveDataToFirestore() {
                if (!currentUserId) return;
                const userDocRef = doc(db, "users", currentUserId);
                await setDoc(userDocRef, appData, { merge: true });
            }
            
            // --- HELPERS --- //
            function getActivePortfolio() {
                if (!appData.portfolios || appData.portfolios.length === 0) {
                    const newPortfolio = { id: Date.now(), name: "My First Portfolio", holdings: [], transactions: [] };
                    appData.portfolios = [newPortfolio];
                    appData.activePortfolioId = newPortfolio.id;
                    saveDataToFirestore();
                    return newPortfolio;
                }
                const activePortfolio = appData.portfolios.find(p => p.id === appData.activePortfolioId);
                if (!activePortfolio) {
                    appData.activePortfolioId = appData.portfolios[0].id;
                    return appData.portfolios[0];
                }
                return activePortfolio;
            }

            // --- NAVIGATION --- //
            function initializeNavigation() {
                mobileMenuBtn.addEventListener('click', () => sidebar.classList.toggle('show'));
                navLinks.forEach(link => {
                    link.addEventListener('click', e => {
                        e.preventDefault();
                        const section = link.getAttribute('data-section');
                        if (section) {
                            showSection(section);
                            sidebar.classList.remove('show');
                        }
                    });
                });
                document.addEventListener('click', e => {
                    if (!sidebar.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
                        sidebar.classList.remove('show');
                    }
                });
            }

            function showSection(sectionName) {
                contentSections.forEach(section => section.classList.remove('active'));
                document.getElementById(sectionName)?.classList.add('active');
                navLinks.forEach(l => l.classList.remove('active'));
                document.querySelector(`.nav-link[data-section="${sectionName}"]`)?.classList.add('active');
                
                // Automatically update prices if navigating to portfolio during market hours
                if (sectionName === 'portfolio') {
                    if (isMarketOpen()) {
                        console.log("Market is open. Automatically updating prices.");
                        updateAllPrices(); 
                    }
                }
            }

            // --- EVENT LISTENERS --- //
            function initializeEventListeners() {
                document.getElementById('loginForm').addEventListener('submit', handleLogin);
                document.getElementById('signupForm').addEventListener('submit', handleSignup);
                document.getElementById('show-signup').addEventListener('click', toggleAuthForms);
                document.getElementById('show-login').addEventListener('click', toggleAuthForms);
                document.getElementById('signOutBtn').addEventListener('click', () => signOut(auth));
                document.getElementById('toggleLoginPassword').addEventListener('click', () => togglePasswordVisibility('loginPassword', 'toggleLoginPassword'));
                document.getElementById('toggleSignupPassword').addEventListener('click', () => togglePasswordVisibility('signupPassword', 'toggleSignupPassword'));

                document.getElementById('addInvestmentBtnPortfolio').addEventListener('click', () => openInvestmentModal());
                document.getElementById('createPortfolioBtn').addEventListener('click', openPortfolioModalForCreate);
                document.getElementById('editPortfolioNameBtn').addEventListener('click', openPortfolioModalForEdit);
                document.getElementById('savePortfolioBtn').addEventListener('click', handleSavePortfolio);
                document.getElementById('portfolioSelector').addEventListener('change', handlePortfolioChange);
                document.getElementById('updatePricesBtn').addEventListener('click', handleUpdatePrices);

                document.getElementById('saveInvestmentBtn').addEventListener('click', handleSaveInvestment);
                document.getElementById('saveAssetEditBtn').addEventListener('click', handleSaveAssetEdit);
                document.getElementById('transactionForm').addEventListener('submit', handleSaveTransaction);
                document.getElementById('preferencesForm').addEventListener('submit', handleSavePreferences);
                document.getElementById('confirmDeleteBtn').addEventListener('click', handleDeleteHolding);
                document.getElementById('openQuestionnaireBtn').addEventListener('click', () => riskQuestionnaireModal.show());
                document.getElementById('submitQuestionnaireBtn').addEventListener('click', handleRiskAnalysis);

                document.getElementById('generateInsightsBtn').addEventListener('click', handlePortfolioAnalysis);
                document.getElementById('getNewsAnalysisBtn').addEventListener('click', handleNewsAnalysis);
                document.getElementById('getAssetInfoBtn').addEventListener('click', handleGetAssetInfo);
                document.getElementById('getAssetInfoBtnEdit').addEventListener('click', handleGetAssetInfoForEdit);

                document.getElementById('portfolioContent').addEventListener('click', (e) => {
                    const assetLink = e.target.closest('.asset-symbol-link');
                    const transactionBtn = e.target.closest('.transaction-btn');
                    const deleteBtn = e.target.closest('.delete-btn');
                    const editBtn = e.target.closest('.edit-btn');
                    
                    if (assetLink) {
                        e.preventDefault();
                        const holdingId = parseInt(assetLink.dataset.id);
                        showAssetProfile(holdingId);
                    } else if (transactionBtn) {
                        e.stopPropagation();
                        const holdingId = parseInt(transactionBtn.dataset.id);
                        openTransactionModal(holdingId);
                    } else if (deleteBtn) {
                        e.stopPropagation(); 
                        holdingIdToModify = parseInt(deleteBtn.dataset.id);
                        deleteConfirmModal.show();
                    } else if (editBtn) {
                        e.stopPropagation();
                        holdingIdToModify = parseInt(editBtn.dataset.id);
                        openEditAssetModal(holdingIdToModify);
                    }
                });
                
                document.getElementById('assetProfileContent').addEventListener('click', (e) => {
                    if (e.target.matches('#backToPortfolioBtn, #backToPortfolioBtn *')) {
                        showSection('portfolio');
                    }
                });

                document.addEventListener('click', (e) => {
                    if(e.target.matches('#addInvestmentBtnDashboard, #addInvestmentBtnEmpty')) {
                        openInvestmentModal();
                    }
                });
            }
            
            // --- AUTHENTICATION --- //
            function initializeAuth() {
                onAuthStateChanged(auth, user => {
                    if (user) {
                        currentUserId = user.uid;
                        appWrapper.classList.remove('logged-out');
                        appWrapper.classList.add('logged-in');
                        loadDataFromFirestore(currentUserId);
                    } else {
                        currentUserId = null;
                        if (unsubscribeFromFirestore) unsubscribeFromFirestore();
                        appData = {};
                        appWrapper.classList.add('logged-out');
                        appWrapper.classList.remove('logged-in');
                    }
                });
            }

            function handleLogin(e) {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                const errorDiv = document.getElementById('login-error');
                signInWithEmailAndPassword(auth, email, password)
                    .catch(error => {
                        errorDiv.textContent = error.message;
                        errorDiv.classList.remove('d-none');
                    });
            }

            function handleSignup(e) {
                e.preventDefault();
                const email = document.getElementById('signupEmail').value;
                const password = document.getElementById('signupPassword').value;
                const errorDiv = document.getElementById('signup-error');
                createUserWithEmailAndPassword(auth, email, password)
                    .catch(error => {
                        errorDiv.textContent = error.message;
                        errorDiv.classList.remove('d-none');
                    });
            }

            function toggleAuthForms(e) {
                e.preventDefault();
                const loginForm = document.getElementById('loginForm');
                const signupForm = document.getElementById('signupForm');
                const isShowingLogin = !loginForm.classList.contains('d-none');
                
                loginForm.classList.toggle('d-none', !isShowingLogin);
                signupForm.classList.toggle('d-none', isShowingLogin);

                document.getElementById('login-error').classList.add('d-none');
                document.getElementById('signup-error').classList.add('d-none');
            }

            function togglePasswordVisibility(passwordInputId, toggleButtonId) {
                const passwordInput = document.getElementById(passwordInputId);
                const icon = document.querySelector(`#${toggleButtonId} i`);
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                icon.classList.toggle('fa-eye');
                icon.classList.toggle('fa-eye-slash');
            }

            // --- RENDERING FUNCTIONS --- //
            async function renderDashboard() {
                const container = document.getElementById('dashboardContent');
                const portfolio = getActivePortfolio();
                
                document.getElementById('dashboard-portfolio-name').textContent = `A real-time overview of your '${portfolio.name}' portfolio.`;

                if (!portfolio.holdings || portfolio.holdings.length === 0) {
                    container.innerHTML = `<div class="empty-state"><i class="fas fa-chart-line"></i><h4>Your Dashboard is Ready</h4><p>Add your first investment to see your portfolio's value, performance, and allocation.</p><button class="btn btn--primary" id="addInvestmentBtnEmpty"><i class="fas fa-plus me-2"></i>Add First Investment</button></div>`;
                    return;
                }

                const { totalValue, dailyChange, dailyChangePercent } = calculatePortfolioMetrics(portfolio);
                const changeClass = dailyChange >= 0 ? 'gain-positive' : 'gain-negative';
                const changeSign = dailyChange >= 0 ? '+' : '';

                container.innerHTML = `
                    <div class="row">
                        <div class="col-lg-4 mb-3"><div class="card metric-card"><div class="card__body d-flex justify-content-between align-items-center"><div><h6>Total Portfolio Value</h6><h3 class="text-primary">${formatCurrency(totalValue)}</h3></div><div class="metric-icon bg-primary"><i class="fas fa-dollar-sign"></i></div></div></div></div>
                        <div class="col-lg-4 mb-3"><div class="card metric-card"><div class="card__body d-flex justify-content-between align-items-center"><div><h6>Total Gain/Loss</h6><h3 class="${changeClass}">${changeSign}${formatCurrency(dailyChange)} (${changeSign}${dailyChangePercent.toFixed(2)}%)</h3></div><div class="metric-icon ${dailyChange >= 0 ? 'bg-success' : 'bg-danger'}"><i class="fas ${dailyChange >= 0 ? 'fa-trending-up' : 'fa-trending-down'}"></i></div></div></div></div>
                        <div class="col-lg-4 mb-3"><div class="card metric-card"><div class="card__body d-flex justify-content-between align-items-center"><div><h6>Total Holdings</h6><h3 class="text-info">${portfolio.holdings.length}</h3></div><div class="metric-icon bg-info"><i class="fas fa-list"></i></div></div></div></div>
                    </div>
                    <div class="row">
                        <div class="col-lg-6 mb-4"><div class="card"><div class="card__body"><h5 class="card-title">Portfolio Allocation</h5><div style="position: relative; height: 300px;"><canvas id="allocationChart"></canvas></div></div></div></div>
                        <div class="col-lg-6 mb-4"><div class="card"><div class="card__body"><h5 class="card-title">Portfolio Performance</h5><div style="position: relative; height: 300px;"><canvas id="performanceChart"></canvas></div></div></div></div>
                    </div>`;
                await initializeCharts(portfolio); // Now async
            }

            function renderPortfolioSelector() {
                const selector = document.getElementById('portfolioSelector');
                selector.innerHTML = (appData.portfolios || []).map(p => `<option value="${p.id}" ${p.id === appData.activePortfolioId ? 'selected' : ''}>${p.name}</option>`).join('');
            }

            function renderPortfolio() {
                const container = document.getElementById('portfolioContent');
                const portfolio = getActivePortfolio();

                if (!portfolio.holdings || portfolio.holdings.length === 0) {
                    container.innerHTML = `<p class="text-center text-muted mt-4">No investments added yet. Click "Add Investment" to start.</p>`;
                    return;
                }
                const holdingsRows = portfolio.holdings.map(h => {
                    const gainLossClass = h.gain_loss >= 0 ? 'gain-positive' : 'gain-negative';
                    const gainLossSign = h.gain_loss >= 0 ? '+' : '';
                    return `
                        <tr>
                            <td>
                                <a href="#" class="asset-symbol-link" data-id="${h.id}">${h.symbol}</a>
                                <br><small class="text-muted">${h.name}</small>
                            </td>
                            <td>${h.shares.toFixed(4)}</td>
                            <td>${formatCurrency(h.current_price)}</td>
                            <td>${formatCurrency(h.total_value)}</td>
                            <td class="${gainLossClass}">${gainLossSign}${formatCurrency(h.gain_loss)} (${gainLossSign}${h.gain_loss_percent.toFixed(2)}%)</td>
                            <td><span class="badge rounded-pill text-bg-light">${h.asset_type}</span></td>
                            <td>
                                <button class="btn btn--secondary btn-sm transaction-btn" data-id="${h.id}" title="Manage Transactions"><i class="fas fa-exchange-alt"></i></button>
                                <button class="btn btn--secondary btn-sm edit-btn" data-id="${h.id}" title="Edit Asset"><i class="fas fa-edit"></i></button>
                                <button class="btn btn--secondary btn-sm delete-btn" data-id="${h.id}" title="Delete Asset"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`;
                }).join('');

                container.innerHTML = `<div class="card"><div class="card__body p-0"><div class="table-responsive"><table class="table table-hover"><thead><tr><th>Symbol</th><th>Shares</th><th>Current Price</th><th>Total Value</th><th>Gain/Loss</th><th>Type</th><th>Actions</th></tr></thead><tbody>${holdingsRows}</tbody></table></div></div></div>`;
            }
            
            function renderInsights() {
                const container = document.getElementById('insightsContainer');
                const insightsCards = (appData.insights || []).map(insight => {
                    const iconMap = { rebalance: 'fa-balance-scale', performance: 'fa-chart-line', risk: 'fa-shield-alt', opportunity: 'fa-lightbulb', news: 'fa-newspaper' };
                    const iconClass = iconMap[insight.type] || 'fa-info-circle';
                    return `<div class="col-md-6 col-lg-4 mb-4"><div class="insight-card"><div class="insight-header"><div class="insight-icon ${insight.type || 'default'}"><i class="fas ${iconClass}"></i></div><h6 class="insight-title">${insight.title}</h6></div><p class="insight-description">${insight.description}</p></div></div>`;
                }).join('');
                container.innerHTML = insightsCards.length > 0 ? insightsCards : '<p class="text-center text-muted">No insights available. Generate new insights based on your portfolio.</p>';
            }

            function renderPreferences() {
                const profile = appData.user_profile;
                if (!profile) return;
                document.getElementById('riskTolerance').value = profile.risk_tolerance;
                document.getElementById('investmentCapital').value = profile.available_capital || '';
                renderCheckboxGroup('subInvestmentGoals', profile.sub_goals || []);
                renderCheckboxGroup('taxConsiderations', profile.tax_considerations || []);
                renderPreferenceGroup('assetClassPrefs', PREF_DEFAULTS.assetClasses, profile.asset_preferences);
                renderPreferenceGroup('sectorPrefs', PREF_DEFAULTS.sectors, profile.sector_preferences);
            }

            function renderCheckboxGroup(containerId, checkedItems) {
                const container = document.getElementById(containerId);
                container.querySelectorAll('.form-check-input').forEach(checkbox => {
                    checkbox.checked = checkedItems.includes(checkbox.value);
                });
            }

            function renderPreferenceGroup(containerId, allItems, preferences) {
                const container = document.getElementById(containerId);
                const prefs = preferences || { preferred: [], excluded: [] };
                container.innerHTML = allItems.map(item => {
                    const isPreferred = prefs.preferred.includes(item);
                    const isExcluded = prefs.excluded.includes(item);
                    const id = `${containerId}-${item.replace(/\s+/g, '')}`;
                    return `
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span>${item}</span>
                            <div class="btn-group" role="group">
                                <input type="radio" class="btn-check" name="${id}" id="${id}-neutral" autocomplete="off" ${!isPreferred && !isExcluded ? 'checked' : ''} data-type="neutral" data-item="${item}">
                                <label class="btn btn-sm btn-outline-secondary" for="${id}-neutral"><i class="fa-solid fa-minus"></i></label>
                                <input type="radio" class="btn-check" name="${id}" id="${id}-preferred" autocomplete="off" ${isPreferred ? 'checked' : ''} data-type="preferred" data-item="${item}">
                                <label class="btn btn-sm btn-outline-success" for="${id}-preferred"><i class="fa-solid fa-thumbs-up"></i></label>
                                <input type="radio" class="btn-check" name="${id}" id="${id}-excluded" autocomplete="off" ${isExcluded ? 'checked' : ''} data-type="excluded" data-item="${item}">
                                <label class="btn btn-sm btn-outline-danger" for="${id}-excluded"><i class="fa-solid fa-thumbs-down"></i></label>
                            </div>
                        </div>`;
                }).join('');
            }

            function renderTransactionHistory(holdingId) {
                const portfolio = getActivePortfolio();
                const holding = portfolio.holdings.find(h => h.id === holdingId);
                const container = document.getElementById('transactionHistoryContainer');
                document.getElementById('transactionHistorySymbol').textContent = holding.symbol;
                const transactions = (portfolio.transactions || []).filter(t => t.holdingId === holdingId).sort((a, b) => new Date(b.date) - new Date(a.date));
                if (transactions.length === 0) {
                    container.innerHTML = '<p class="text-muted text-center">No transactions recorded for this asset yet.</p>';
                    return;
                }
                container.innerHTML = `<table class="table table-sm"><tbody>${transactions.map(t => `<tr><td>${new Date(t.date).toLocaleDateString()}</td><td><span class="badge bg-${t.type.toLowerCase()}">${t.type}</span></td><td>${t.type !== 'Dividend' ? `${t.shares} @ ${formatCurrency(t.price)}` : ''}</td><td class="text-end"><strong>${formatCurrency(t.total)}</strong></td></tr>`).join('')}</tbody></table>`;
            }

            // --- CHARTING --- //
            async function initializeCharts(portfolio) {
                initializeAllocationChart(portfolio);
                await initializePerformanceChart(portfolio); // Now async
            }

            function initializeAllocationChart(portfolio) {
                const ctx = document.getElementById('allocationChart')?.getContext('2d');
                if (!ctx) return;
                const allocation = {};
                (portfolio.holdings || []).forEach(h => {
                    allocation[h.asset_type] = (allocation[h.asset_type] || 0) + h.total_value;
                });
                if (allocationChart) allocationChart.destroy();
                allocationChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(allocation),
                        datasets: [{ data: Object.values(allocation), backgroundColor: ['#2196F3', '#4CAF50', '#FFC107', '#E91E63', '#9C27B0', '#607D8B'], borderWidth: 2, borderColor: 'var(--color-surface)' }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { formatter: (value, ctx) => { const datapoints = ctx.chart.data.datasets[0].data; const total = datapoints.reduce((total, datapoint) => total + datapoint, 0); const percentage = total > 0 ? (value / total * 100).toFixed(1) : 0; return `${ctx.chart.data.labels[ctx.dataIndex]}\n${percentage}%`; }, color: '#fff', font: { weight: 'bold', size: 12, }, textShadowColor: 'rgba(0,0,0,0.3)', textShadowBlur: 4, } } }
                });
            }

            async function initializePerformanceChart(portfolio) {
                const chartContainer = document.getElementById('performanceChart')?.parentElement;
                if (!chartContainer) return;

                if (performanceChart) {
                    performanceChart.destroy();
                }

                // Display a loading spinner while fetching and calculating data
                chartContainer.innerHTML = `<div class="spinner-container"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading performance data...</span></div></div>`;

                try {
                    const performanceData = await generateDailyPerformanceData(portfolio);

                    // Restore the canvas element
                    chartContainer.innerHTML = '<canvas id="performanceChart"></canvas>';
                    const ctx = document.getElementById('performanceChart').getContext('2d');
                    
                    if (!performanceData || performanceData.labels.length === 0) {
                         chartContainer.innerHTML = '<div class="text-center p-4 text-muted">Not enough historical data to display performance chart.</div>';
                         return;
                    }

                    performanceChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: performanceData.labels,
                            datasets: [{ 
                                label: 'Portfolio Value', 
                                data: performanceData.data, 
                                borderColor: 'var(--color-primary)', 
                                borderWidth: 2, 
                                fill: true,
                                backgroundColor: 'rgba(var(--color-teal-500-rgb), 0.1)',
                                tension: 0.1, 
                                pointRadius: 0,
                                pointHoverRadius: 5,
                                pointHitRadius: 10,
                                pointHoverBackgroundColor: 'var(--color-primary)',
                            }]
                        },
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: false, 
                            plugins: { 
                                legend: { display: false }, 
                                datalabels: { display: false },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    callbacks: {
                                        label: (context) => `Value: ${formatCurrency(context.parsed.y)}`
                                    }
                                }
                            }, 
                            scales: { 
                                y: { 
                                    ticks: { callback: value => formatCurrency(value) } 
                                }, 
                                x: { 
                                    ticks: { 
                                        maxRotation: 45, 
                                        minRotation: 45,
                                        autoSkip: true,
                                        maxTicksLimit: 10
                                    } 
                                } 
                            } 
                        }
                    });
                } catch (error) {
                    console.error("Failed to generate performance chart:", error);
                    chartContainer.innerHTML = `<div class="text-center p-4 text-danger">Error loading chart data: ${error.message}</div>`;
                }
            }
            
            // --- CORE LOGIC & HANDLERS --- //
            function openInvestmentModal() {
                const portfolio = getActivePortfolio();
                document.getElementById('investmentForm').reset();
                document.getElementById('investmentDate').valueAsDate = new Date();
                document.getElementById('modalPortfolioName').textContent = portfolio.name;
                document.getElementById('companyInfoCard').classList.add('d-none');
                document.getElementById('companyInfoContent').innerHTML = '';
                investmentModal.show();
            }
            
            function openEditAssetModal(holdingId) {
                const portfolio = getActivePortfolio();
                const holding = portfolio.holdings.find(h => h.id === holdingId);
                if (!holding) return;
                document.getElementById('editAssetId').value = holding.id;
                document.getElementById('editAssetSymbol').value = holding.symbol;
                document.getElementById('editAssetName').value = holding.name;
                document.getElementById('editAssetType').value = holding.asset_type;
                document.getElementById('editAssetInfoCard').classList.add('d-none');
                editAssetModal.show();
            }

            function openTransactionModal(holdingId) {
                document.getElementById('transactionForm').reset();
                document.getElementById('transactionDate').valueAsDate = new Date();
                document.getElementById('transactionHoldingId').value = holdingId;
                renderTransactionHistory(holdingId);
                transactionModal.show();
            }

            function openPortfolioModalForCreate() {
                document.getElementById('portfolioForm').reset();
                document.getElementById('editPortfolioId').value = '';
                document.getElementById('portfolioModalTitle').textContent = 'Create New Portfolio';
                portfolioModal.show();
            }
            
            function openPortfolioModalForEdit() {
                const portfolio = getActivePortfolio();
                if (!portfolio) return;
                document.getElementById('portfolioForm').reset();
                document.getElementById('editPortfolioId').value = portfolio.id;
                document.getElementById('portfolioName').value = portfolio.name;
                document.getElementById('portfolioModalTitle').textContent = 'Edit Portfolio Name';
                portfolioModal.show();
            }

            function handlePortfolioChange(e) {
                appData.activePortfolioId = parseInt(e.target.value);
                saveDataToFirestore();
            }

            function handleSavePortfolio() {
                const portfolioId = document.getElementById('editPortfolioId').value;
                const nameInput = document.getElementById('portfolioName');
                const name = nameInput.value.trim();
                if (!name) return;

                if (portfolioId) { // Editing existing
                    const portfolio = appData.portfolios.find(p => p.id == portfolioId);
                    if (portfolio) portfolio.name = name;
                } else { // Creating new
                    const newPortfolio = { id: Date.now(), name: name, holdings: [], transactions: [] };
                    appData.portfolios.push(newPortfolio);
                    appData.activePortfolioId = newPortfolio.id;
                }
                saveDataToFirestore();
                portfolioModal.hide();
            }

            function handleSaveInvestment() {
                const portfolio = getActivePortfolio();
                const transactionData = {
                    type: 'Buy',
                    date: document.getElementById('investmentDate').value,
                    shares: parseFloat(document.getElementById('investmentShares').value),
                    price: parseFloat(document.getElementById('investmentPrice').value)
                };
                if (!transactionData.date || !transactionData.shares || !transactionData.price) { alert("Please fill all purchase details: Shares, Price, and Date."); return; }
                
                const newHolding = {
                    id: Date.now(),
                    symbol: document.getElementById('investmentSymbol').value.toUpperCase(),
                    name: document.getElementById('investmentName').value,
                    asset_type: document.getElementById('investmentType').value,
                    current_price: transactionData.price,
                    shares: 0, average_cost: 0, total_value: 0, gain_loss: 0, gain_loss_percent: 0, fundamentals: null
                };
                if(!newHolding.symbol || !newHolding.name) { alert("Please fill out at least the Symbol and Name."); return; }
                if (portfolio.holdings.find(h => h.symbol === newHolding.symbol)) { alert(`Asset with symbol ${newHolding.symbol} already exists. Please add transactions to the existing asset.`); return; }
                
                portfolio.holdings.push(newHolding);
                
                transactionData.holdingId = newHolding.id;
                transactionData.total = transactionData.shares * transactionData.price;
                if (!portfolio.transactions) portfolio.transactions = [];
                portfolio.transactions.push(transactionData);

                recalculateHolding(newHolding.id);
                saveDataToFirestore();
                investmentModal.hide();
            }

            function handleSaveAssetEdit() {
                const portfolio = getActivePortfolio();
                const holdingId = parseInt(document.getElementById('editAssetId').value);
                const holding = portfolio.holdings.find(h => h.id === holdingId);
                if (!holding) return;

                holding.symbol = document.getElementById('editAssetSymbol').value.toUpperCase();
                holding.name = document.getElementById('editAssetName').value;
                holding.asset_type = document.getElementById('editAssetType').value;

                saveDataToFirestore();
                editAssetModal.hide();
            }

            function handleSaveTransaction(e) {
                e.preventDefault();
                const portfolio = getActivePortfolio();
                const holdingId = parseInt(document.getElementById('transactionHoldingId').value);
                const transactionData = {
                    holdingId: holdingId,
                    type: document.getElementById('transactionType').value,
                    date: document.getElementById('transactionDate').value,
                    shares: parseFloat(document.getElementById('transactionShares').value),
                    price: parseFloat(document.getElementById('transactionPrice').value)
                };
                if (!transactionData.date || !transactionData.shares || (!transactionData.price && transactionData.type !== 'Dividend')) { alert("Please fill all required fields."); return; }
                transactionData.total = transactionData.type === 'Dividend' ? transactionData.shares : transactionData.shares * transactionData.price;
                if (transactionData.type === 'Sell') {
                    const holding = portfolio.holdings.find(h => h.id === holdingId);
                    if (transactionData.shares > holding.shares) { alert(`Cannot sell more shares (${transactionData.shares}) than you own (${holding.shares}).`); return; }
                }
                if (!portfolio.transactions) portfolio.transactions = [];
                portfolio.transactions.push(transactionData);

                const holding = portfolio.holdings.find(h => h.id === holdingId);
                if (holding && transactionData.type !== 'Dividend') {
                    holding.current_price = transactionData.price;
                }

                recalculateHolding(holdingId);
                saveDataToFirestore();
                renderTransactionHistory(holdingId);
                document.getElementById('transactionForm').reset();
                document.getElementById('transactionDate').valueAsDate = new Date();
            }

            function handleDeleteHolding() {
                if (holdingIdToModify === null) return;
                const portfolio = getActivePortfolio();
                portfolio.holdings = portfolio.holdings.filter(h => h.id !== holdingIdToModify);
                portfolio.transactions = portfolio.transactions.filter(t => t.holdingId !== holdingIdToModify);
                holdingIdToModify = null;
                saveDataToFirestore();
                deleteConfirmModal.hide();
            }
            
            function handleSavePreferences(e) {
                e.preventDefault();
                const profile = appData.user_profile;
                profile.risk_tolerance = document.getElementById('riskTolerance').value;
                profile.available_capital = parseFloat(document.getElementById('investmentCapital').value) || 0;
                profile.sub_goals = getCheckedValues('subInvestmentGoals');
                profile.tax_considerations = getCheckedValues('taxConsiderations');
                profile.asset_preferences = getPreferenceValues('assetClassPrefs');
                profile.sector_preferences = getPreferenceValues('sectorPrefs');
                saveDataToFirestore();
                const msgEl = document.getElementById('preferencesMessage');
                msgEl.innerHTML = `<div class="alert alert-success" role="alert">Preferences saved successfully!</div>`;
                setTimeout(() => msgEl.innerHTML = '', 3000);
            }
            
            function getCheckedValues(containerId) {
                const container = document.getElementById(containerId);
                return Array.from(container.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
            }

            function getPreferenceValues(containerId) {
                const container = document.getElementById(containerId);
                const preferences = { preferred: [], excluded: [] };
                container.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
                    if (radio.dataset.type === 'preferred') {
                        preferences.preferred.push(radio.dataset.item);
                    } else if (radio.dataset.type === 'excluded') {
                        preferences.excluded.push(radio.dataset.item);
                    }
                });
                return preferences;
            }

            // --- CALCULATION LOGIC --- //
            function recalculateHolding(holdingId) {
                const portfolio = getActivePortfolio();
                const holding = portfolio.holdings.find(h => h.id === holdingId);
                if (!holding) return;

                const transactions = portfolio.transactions.filter(t => t.holdingId === holdingId);
                const buyTransactions = transactions.filter(t => t.type === 'Buy');
                
                const totalSharesBought = buyTransactions.reduce((sum, t) => sum + t.shares, 0);
                const totalSharesSold = transactions.filter(t => t.type === 'Sell').reduce((sum, t) => sum + t.shares, 0);
                const totalCost = buyTransactions.reduce((sum, t) => sum + t.total, 0);

                holding.shares = totalSharesBought - totalSharesSold;
                holding.average_cost = totalSharesBought > 0 ? totalCost / totalSharesBought : 0;
                
                holding.total_value = holding.shares * holding.current_price;
                const costBasisForCurrentShares = holding.shares * holding.average_cost;
                holding.gain_loss = holding.total_value - costBasisForCurrentShares;
                holding.gain_loss_percent = costBasisForCurrentShares > 0 ? (holding.gain_loss / costBasisForCurrentShares) * 100 : 0;
            }

            function calculatePortfolioMetrics(portfolio) {
                if (!portfolio || !portfolio.holdings) return { totalValue: 0, dailyChange: 0, dailyChangePercent: 0 };
                const totalValue = portfolio.holdings.reduce((sum, h) => sum + h.total_value, 0);
                const totalGainLoss = portfolio.holdings.reduce((sum, h) => sum + h.gain_loss, 0);
                const totalInvested = portfolio.holdings.reduce((sum, h) => sum + (h.average_cost * h.shares), 0);
                return {
                    totalValue: totalValue,
                    dailyChange: totalGainLoss, // Simplified to total gain/loss
                    dailyChangePercent: totalInvested > 0 ? (totalGainLoss / totalInvested) * 100 : 0
                };
            }

            // --- DAILY PERFORMANCE CALCULATION (NEW) --- //
            async function generateDailyPerformanceData(portfolio) {
                const { holdings, transactions } = portfolio;
                if (!holdings || holdings.length === 0 || !transactions || transactions.length === 0) {
                    return null;
                }
                
                const holdingDetails = holdings.map(h => {
                    const holdingTransactions = transactions.filter(t => t.holdingId === h.id);
                    if (holdingTransactions.length === 0) return null;
                    const firstDate = holdingTransactions.sort((a,b) => new Date(a.date) - new Date(b.date))[0].date;
                    // Determine output size based on how old the first transaction is
                    const daysDiff = (new Date() - new Date(firstDate)) / (1000 * 60 * 60 * 24);
                    const outputSize = daysDiff > 100 ? 'full' : 'compact';
                    return { symbol: h.symbol, id: h.id, outputSize };
                }).filter(Boolean);

                // 1. Fetch all historical prices in parallel
                const pricePromises = holdingDetails.map(h => fetchAlphaVantageData(h.symbol, h.outputSize));
                const historicalPricesArray = await Promise.all(pricePromises);

                // 2. Process data for fast lookups
                const priceDataBySymbol = new Map();
                historicalPricesArray.forEach((priceHistory, index) => {
                    if (priceHistory && priceHistory.length > 0) {
                        const symbol = holdingDetails[index].symbol;
                        priceDataBySymbol.set(symbol, new Map(priceHistory.map(p => [p.date, p.price])));
                    }
                });

                // 3. Calculate daily portfolio values
                const portfolioHistory = calculateDailyPortfolioValues(portfolio, priceDataBySymbol);
                if (portfolioHistory.length < 2) return null;

                // 4. Format for Chart.js
                const labels = portfolioHistory.map(p => new Date(p.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }));
                const data = portfolioHistory.map(p => p.value);

                return { labels, data };
            }

            function calculateDailyPortfolioValues(portfolio, priceDataBySymbol) {
                const { holdings, transactions } = portfolio;
                if (!transactions || transactions.length === 0) return [];

                const sortedTransactions = [...transactions].sort((a,b) => new Date(a.date) - new Date(b.date));
                const portfolioStartDate = new Date(sortedTransactions[0].date);
                const today = new Date();
                
                const portfolioHistory = [];
                let currentDate = portfolioStartDate;
                let lastKnownPrices = {}; 

                // Initialize last known prices from current holding data as a fallback
                holdings.forEach(h => {
                    lastKnownPrices[h.symbol] = h.current_price;
                });

                while (currentDate <= today) {
                    const dateStr = toYYYYMMDD(currentDate);
                    let dailyTotalValue = 0;

                    for (const holding of holdings) {
                        const prices = priceDataBySymbol.get(holding.symbol);
                        let priceOnDate = prices ? prices.get(dateStr) : undefined;
                        
                        if (priceOnDate !== undefined) {
                            lastKnownPrices[holding.symbol] = priceOnDate; // Update last known price
                        } else {
                            priceOnDate = lastKnownPrices[holding.symbol]; // Use last known price if no price for today (weekend/holiday)
                        }
                        
                        const sharesOnDate = getSharesOnDate(holding.id, dateStr, transactions);
                        if (sharesOnDate > 0) {
                            dailyTotalValue += sharesOnDate * priceOnDate;
                        }
                    }
                    
                    if (dailyTotalValue > 0 || portfolioHistory.length > 0) {
                        portfolioHistory.push({ date: dateStr, value: dailyTotalValue });
                    }
                    
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                return portfolioHistory;
            }

            function getSharesOnDate(holdingId, dateStr, allTransactions) {
                const targetDate = new Date(dateStr);
                return allTransactions
                    .filter(t => t.holdingId === holdingId && new Date(t.date) <= targetDate)
                    .reduce((totalShares, t) => {
                        if (t.type === 'Buy') return totalShares + t.shares;
                        if (t.type === 'Sell') return totalShares - t.shares;
                        return totalShares;
                    }, 0);
            }

            // --- GEMINI & API HANDLERS --- //
            
            async function handleGetAssetInfo() {
                const symbol = document.getElementById('investmentSymbol').value.toUpperCase();
                if (!symbol) { alert("Please enter a symbol first."); return; }
            
                const btn = document.getElementById('getAssetInfoBtn');
                const originalText = btn.innerHTML;
                btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span>`;
                btn.disabled = true;
            
                const infoCard = document.getElementById('companyInfoCard');
                const infoContent = document.getElementById('companyInfoContent');
            
                try {
                    const data = await finnhubApiCall('stock/profile2', `symbol=${symbol}`);
                    if (!data || Object.keys(data).length === 0) throw new Error(`No data found for symbol "${symbol}". It may be invalid or not supported.`);
            
                    document.getElementById('investmentName').value = data.name || '';
                    document.getElementById('investmentType').value = data.finnhubIndustry === 'CRYPTOCURRENCY' ? 'Crypto' : 'Stock';
                    
                    infoContent.innerHTML = `
                        <h6 class="card-title">${data.name} <span class="badge bg-secondary">${data.ticker}</span></h6>
                        <p class="card-text small mb-1"><strong>Industry:</strong> ${data.finnhubIndustry || 'N/A'}</p>
                        <p class="card-text small"><strong>Exchange:</strong> ${data.exchange || 'N/A'}</p>`;
                    infoCard.classList.remove('d-none');
            
                } catch (error) {
                    console.error("Error fetching asset info from Finnhub:", error);
                    infoContent.innerHTML = `<p class="card-text text-danger">${error.message}</p>`;
                    infoCard.classList.remove('d-none');
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
            
            async function handleGetAssetInfoForEdit() {
                const symbol = document.getElementById('editAssetSymbol').value.toUpperCase();
                if (!symbol) { alert("Please enter a symbol first."); return; }
            
                const btn = document.getElementById('getAssetInfoBtnEdit');
                const originalText = btn.innerHTML;
                btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span>`;
                btn.disabled = true;
            
                const infoCard = document.getElementById('editAssetInfoCard');
                const infoContent = document.getElementById('editAssetInfoContent');
            
                try {
                    const data = await finnhubApiCall('stock/profile2', `symbol=${symbol}`);
                    if (!data || Object.keys(data).length === 0) throw new Error(`No data found for symbol "${symbol}". It may be invalid or not supported.`);
            
                    document.getElementById('editAssetName').value = data.name || '';
                    document.getElementById('editAssetType').value = data.finnhubIndustry === 'CRYPTOCURRENCY' ? 'Crypto' : 'Stock';

                    infoContent.innerHTML = `
                        <h6 class="card-title">${data.name} <span class="badge bg-secondary">${data.ticker}</span></h6>
                        <p class="card-text small mb-1"><strong>Industry:</strong> ${data.finnhubIndustry || 'N/A'}</p>
                        <p class="card-text small"><strong>Exchange:</strong> ${data.exchange || 'N/A'}</p>`;
                    infoCard.classList.remove('d-none');
            
                } catch (error) {
                    console.error("Error fetching asset info from Finnhub:", error);
                    infoContent.innerHTML = `<p class="card-text text-danger">${error.message}</p>`;
                    infoCard.classList.remove('d-none');
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
            
            async function handlePortfolioAnalysis() {
                const btn = document.getElementById('generateInsightsBtn');
                const originalText = btn.innerHTML;
                btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Analyzing...`;
                btn.disabled = true;

                const portfolio = getActivePortfolio();
                const userProfile = appData.user_profile;
                const { totalValue } = calculatePortfolioMetrics(portfolio);

                // Construct a detailed summary of the user's profile
                const userProfileSummary = `
                    **User Investment Profile:**
                    - **Risk Tolerance:** ${userProfile.risk_tolerance || 'Not set'}
                    - **Investment Goals:** ${(userProfile.sub_goals || []).join(', ') || 'Not set'}
                    - **Available Capital for Investment:** ${formatCurrency(userProfile.available_capital) || 'Not set'}
                    - **Tax Considerations:** ${(userProfile.tax_considerations || []).join(', ') || 'None'}
                    - **Preferred Asset Classes:** ${(userProfile.asset_preferences?.preferred || []).join(', ') || 'None'}
                    - **Excluded Asset Classes:** ${(userProfile.asset_preferences?.excluded || []).join(', ') || 'None'}
                    - **Preferred Sectors/Industries:** ${(userProfile.sector_preferences?.preferred || []).join(', ') || 'None'}
                    - **Excluded Sectors/Industries:** ${(userProfile.sector_preferences?.excluded || []).join(', ') || 'None'}
                `;

                // Construct the portfolio summary
                const portfolioSummary = `
                    **Current Portfolio ('${portfolio.name}'):**
                    - **Total Value:** ${formatCurrency(totalValue)}
                    - **Holdings:**
                    ${portfolio.holdings.map(h => `  - ${h.shares.toFixed(2)} shares of ${h.symbol} (${h.name}), Type: ${h.asset_type}, Current Value: ${formatCurrency(h.total_value)}`).join('\n') || '  - No holdings in this portfolio.'}
                `;

                // Construct the final prompt for Gemini
                const fullPrompt = `
                    You are an expert AI financial advisor. Your task is to analyze a user's investment portfolio in the context of their detailed investment profile. Provide actionable, personalized insights and asset allocation recommendations.

                    ${userProfileSummary}

                    ${portfolioSummary}

                    **Instructions:**
                    Based on all the information above, please provide 3-4 clear, actionable insights. Critically evaluate the current portfolio against the user's goals and preferences. Recommendations should be specific (e.g., "Consider reducing exposure to Technology stocks and increasing allocation to Healthcare to better align with your sector preferences and risk tolerance.").

                    For each insight, provide a 'type' (one of: 'rebalance', 'performance', 'risk', 'opportunity'), a short 'title', and a concise 'description' (1-2 sentences).

                    Format the entire output as a single JSON array of objects.
                `;

                try {
                    const newInsights = await generateContent(fullPrompt, { responseMimeType: "application/json", responseSchema: { type: "ARRAY", items: { type: "OBJECT", properties: { "type": { "type": "STRING" }, "title": { "type": "STRING" }, "description": { "type": "STRING" } }, required: ["type", "title", "description"] } } });
                    appData.insights = newInsights;
                    saveDataToFirestore();
                } catch (error) {
                    console.error("Error generating insights:", error);
                    appData.insights.unshift({ type: 'risk', title: 'Error', description: 'Could not generate portfolio insights at this time.' });
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }

            async function handleNewsAnalysis() {
                const btn = document.getElementById('getNewsAnalysisBtn');
                const originalText = btn.innerHTML;
                btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Analyzing...`;
                btn.disabled = true;
                const prompt = `Act as a financial analyst. Provide a summary of the top 3-4 financial news headlines for today. For each, briefly explain the potential impact on the market. Present each as an insight with a 'type' of "news", a 'title' from the headline, and a 'description' with the analysis. Format as a JSON array of objects.`;
                try {
                    const newsInsights = await generateContent(prompt, { responseMimeType: "application/json", responseSchema: { type: "ARRAY", items: { type: "OBJECT", properties: { "type": { "type": "STRING" }, "title": { "type": "STRING" }, "description": { "type": "STRING" } }, required: ["type", "title", "description"] } } });
                    appData.insights = [...newsInsights, ...appData.insights.filter(i => i.type !== 'news')];
                    saveDataToFirestore();
                } catch (error) {
                    console.error("Error generating news analysis:", error);
                    appData.insights.unshift({ type: 'risk', title: 'Error', description: 'Could not generate news analysis at this time.' });
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }

            async function handleRiskAnalysis(e) {
                e.preventDefault();
                const btn = document.getElementById('submitQuestionnaireBtn');
                const originalText = btn.innerHTML;
                btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Analyzing...`;
                btn.disabled = true;

                const form = document.getElementById('riskQuestionnaireForm');
                const formData = new FormData(form);
                let answers = "";
                for (const [key, value] of formData.entries()) {
                    const label = form.querySelector(`input[name="${key}"][value="${value}"]`).closest('.form-check').querySelector('.form-check-label').textContent;
                    const question = form.querySelector(`input[name="${key}"]`).closest('.mb-3').querySelector('.form-label').textContent;
                    answers += `${question}\nAnswer: ${label}\n\n`;
                }

                const prompt = `Based on the following answers to a risk tolerance questionnaire, determine the user's risk tolerance level (Low, Moderate, or High) and provide a brief, one-sentence justification. \n\n${answers} \n\nReturn the result as a single JSON object with keys "riskTolerance" and "justification". The riskTolerance value must be one of "Low", "Moderate", or "High".`;

                const resultContainer = document.getElementById('riskAnalysisResult');
                try {
                    const result = await generateContent(prompt, { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { "riskTolerance": { "type": "STRING" }, "justification": { "type": "STRING" } }, required: ["riskTolerance", "justification"] } });
                    document.getElementById('riskTolerance').value = result.riskTolerance;
                    resultContainer.innerHTML = `<i class="fas fa-check-circle text-success me-1"></i><strong>AI Assessment:</strong> ${result.justification}`;
                    riskQuestionnaireModal.hide();
                } catch (error) {
                    console.error("Error performing risk analysis:", error);
                    resultContainer.innerHTML = `<i class="fas fa-times-circle text-danger me-1"></i>Could not perform analysis. Please try again.`;
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }

            async function generateContent(prompt, generationConfig = {}) {
                const url = 'https://gemini-proxy-835285817704.us-east4.run.app/'; 
                const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig };
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { const errorBody = await response.text(); console.error("API Error Response:", errorBody); throw new Error(`API call failed with status: ${response.status}`); }
                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                if (!part || !part.text) { console.error("Invalid API response structure:", JSON.stringify(result, null, 2)); throw new Error("Invalid response from API: No text part found."); }
                return JSON.parse(part.text);
            }
            
            // --- DATA APIs --- //
            /**
             * Fetches historical daily prices for a given symbol from Alpha Vantage.
             * This function can be called directly from the browser without a proxy.
             * @param {string} symbol The stock symbol (e.g., 'AAPL').
             * @param {string} outputSize 'compact' for last 100 days, 'full' for all available data.
             * @returns {Promise<Array<{date: string, price: number}>>} A promise that resolves to an array of price data.
             */
            async function fetchAlphaVantageData(symbol, outputSize = 'compact') {
                const apiKey = alphaVantageApiKey.trim();
                if (!apiKey || apiKey === 'alphaVantageApiKey') {
                    throw new Error("Alpha Vantage API key is not configured. Please get a free key and add it to your GitHub Secrets.");
                }

                const url = `https://www.alphavantage.co/query?function=TIME_SERIES_DAILY_ADJUSTED&symbol=${symbol}&outputsize=${outputSize}&apikey=${apiKey}`;

                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`Alpha Vantage API request failed for ${symbol} with status: ${response.status}`);
                    }
                    const data = await response.json();

                    // Check for API error messages or rate limit notes in the response body
                    if (data["Error Message"]) {
                         throw new Error(`API Error for ${symbol}: ${data["Error Message"]}`);
                    }
                    if (data["Note"]) {
                        // The "Note" key often contains messages about API call frequency limits.
                        throw new Error(`API Note for ${symbol}: ${data["Note"]}`);
                    }

                    const timeSeries = data['Time Series (Daily)'];
                    if (!timeSeries) {
                        throw new Error(`No time series data found for ${symbol}. The symbol may be invalid or the API limit reached.`);
                    }
                    
                    // Parse the data from its object format to the array format the rest of the app expects
                    const priceHistory = Object.entries(timeSeries).map(([date, values]) => ({
                        date: date,
                        // We use the '5. adjusted close' for the most accuracy, as it accounts for dividends and splits.
                        price: parseFloat(values['5. adjusted close'])
                    }));
                    
                    // The data comes in reverse chronological order, so we reverse it to be chronological.
                    return priceHistory.reverse();

                } catch (error) {
                    console.error(`Failed to fetch historical data for ${symbol} from Alpha Vantage:`, error);
                    throw error;
                }
            }

            async function finnhubApiCall(endpoint, params) {
                const apiKey = finnhubApiKey.trim();
                if (!apiKey || apiKey === "finnhubApiKey") {
                    console.error("Finnhub API key is not configured. Please set it up in your deployment secrets.");
                    return null;
                }
                const url = `https://finnhub.io/api/v1/${endpoint}?${params}&token=${apiKey}`;
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        console.error(`Finnhub API error for ${endpoint}: ${response.statusText}`);
                        return null;
                    }
                    const data = await response.json();
                    if (Object.keys(data).length === 0) {
                        // This can happen for valid symbols with no data, so just warn instead of erroring.
                        console.warn(`No data returned from Finnhub for ${endpoint} with params: ${params}`);
                        return null;
                    }
                    return data;
                } catch (error) {
                    console.error(`Error fetching from Finnhub (${endpoint}):`, error);
                    return null;
                }
            }

            async function updateAllPrices(btn = null) {
                let originalText;
                if (btn) {
                    originalText = btn.innerHTML;
                    btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Updating...`;
                    btn.disabled = true;
                }

                const portfolio = getActivePortfolio();
                if (!portfolio || !portfolio.holdings || portfolio.holdings.length === 0) {
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    }
                    return; 
                }
                
                const pricePromises = portfolio.holdings.map(h => 
                    finnhubApiCall('quote', `symbol=${h.symbol}`)
                        .then(data => ({ id: h.id, price: data ? data.c : null }))
                );

                try {
                    const results = await Promise.all(pricePromises);
                    let pricesUpdated = false;
                    results.forEach(result => {
                        const holding = portfolio.holdings.find(h => h.id === result.id);
                        if (holding && result.price && holding.current_price !== result.price) {
                            holding.current_price = result.price;
                            recalculateHolding(holding.id);
                            pricesUpdated = true;
                        }
                    });
                    
                    if (pricesUpdated) {
                        await saveDataToFirestore();
                    }
                } catch (error) {
                    console.error("Error updating prices:", error);
                    if (btn) {
                        alert("An error occurred while updating prices. Please check your API key and network connection.");
                    }
                } finally {
                    if (btn) {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                }
            }

            function handleUpdatePrices(e) {
                updateAllPrices(e.currentTarget);
            }
            
            // --- ASSET PROFILE PAGE --- //
            async function showAssetProfile(holdingId) {
                const portfolio = getActivePortfolio();
                const holding = portfolio.holdings.find(h => h.id === holdingId);
                if (!holding) return;

                showSection('asset-profile');
                const container = document.getElementById('assetProfileContent');
                container.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <button class="btn btn--secondary" id="backToPortfolioBtn"><i class="fas fa-arrow-left me-2"></i>Back to Portfolio</button>
                    </div>
                    <div class="spinner-container card"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>
                `;

                const [profile, quote, financials, earnings] = await Promise.all([
                    finnhubApiCall('stock/profile2', `symbol=${holding.symbol}`),
                    finnhubApiCall('quote', `symbol=${holding.symbol}`),
                    finnhubApiCall('stock/metric', `symbol=${holding.symbol}&metric=all`),
                    finnhubApiCall('calendar/earnings', `symbol=${holding.symbol}`)
                ]);
                
                renderAssetProfileData(container, { profile, quote, financials, earnings });
                
                const geminiContainer = document.getElementById('geminiAnalysisContainer');
                if (geminiContainer) {
                    try {
                        const prompt = createGeminiPrompt({ profile, quote, financials, earnings });
                        const schema = {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "OBJECT",
                                properties: {
                                    "summary": { "type": "STRING" },
                                    "recommendation": { "type": "STRING" },
                                    "confidence": { "type": "STRING" },
                                    "reasoning": { "type": "STRING" },
                                    "news": { "type": "ARRAY", "items": { "type": "STRING" } }
                                },
                                required: ["summary", "recommendation", "confidence", "reasoning", "news"]
                            }
                        };

                        const analysis = await generateContent(prompt, schema);
                        renderGeminiAnalysis(geminiContainer, analysis);

                    } catch (error) {
                        console.error("Error generating Gemini analysis:", error);
                        geminiContainer.innerHTML = `<div class="alert alert-danger">Could not generate AI analysis at this time. ${error.message}</div>`;
                    }
                }
            }

            function renderAssetProfileData(container, data) {
                const { profile, quote, financials, earnings } = data;

                const quoteChangeClass = quote?.d >= 0 ? 'gain-positive' : 'gain-negative';
                const quoteChangeSign = quote?.d >= 0 ? '+' : '';

                container.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <button class="btn btn--secondary" id="backToPortfolioBtn"><i class="fas fa-arrow-left me-2"></i>Back to Portfolio</button>
                    </div>

                    <div class="card mb-4">
                        <div class="card-body d-flex align-items-center">
                            ${profile?.logo ? `<img src="${profile.logo}" alt="logo" class="me-3" style="width: 60px; height: 60px; border-radius: var(--radius-base);">` : ''}
                            <div>
                                <h2 class="mb-0">${profile?.name || 'N/A'}</h2>
                                <p class="text-secondary mb-0">${profile?.ticker || 'N/A'} &bull; ${profile?.exchange || 'N/A'}</p>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-lg-6">
                            <div class="card mb-4">
                                <div class="card-header"><h5>Latest Quote</h5></div>
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h3 class="mb-0">${formatCurrency(quote?.c)}</h3>
                                        <h4 class="${quoteChangeClass} mb-0">${quoteChangeSign}${formatCurrency(quote?.d)} (${quoteChangeSign}${quote?.dp?.toFixed(2)}%)</h4>
                                    </div>
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item d-flex justify-content-between"><span>Open</span><strong>${formatCurrency(quote?.o)}</strong></li>
                                        <li class="list-group-item d-flex justify-content-between"><span>High</span><strong>${formatCurrency(quote?.h)}</strong></li>
                                        <li class="list-group-item d-flex justify-content-between"><span>Low</span><strong>${formatCurrency(quote?.l)}</strong></li>
                                        <li class="list-group-item d-flex justify-content-between"><span>Previous Close</span><strong>${formatCurrency(quote?.pc)}</strong></li>
                                    </ul>
                                </div>
                            </div>

                            <div class="card mb-4">
                                <div class="card-header"><h5>Key Financials</h5></div>
                                <div class="card-body">
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item d-flex justify-content-between"><span>Market Cap</span><strong>${formatCurrency((financials?.metric?.marketCapitalization || 0) * 1000000)}</strong></li>
                                        <li class="list-group-item d-flex justify-content-between"><span>52-Week High</span><strong>${formatCurrency(financials?.metric?.['52WeekHigh'])}</strong></li>
                                        <li class="list-group-item d-flex justify-content-between"><span>52-Week Low</span><strong>${formatCurrency(financials?.metric?.['52WeekLow'])}</strong></li>
                                        <li class="list-group-item d-flex justify-content-between"><span>P/E Ratio</span><strong>${financials?.metric?.peNormalizedAnnual?.toFixed(2) || 'N/A'}</strong></li>
                                        <li class="list-group-item d-flex justify-content-between"><span>EPS (TTM)</span><strong>${financials?.metric?.epsNormalizedAnnual?.toFixed(2) || 'N/A'}</strong></li>
                                        <li class="list-group-item d-flex justify-content-between"><span>Dividend Yield</span><strong>${(financials?.metric?.dividendYieldIndicatedAnnual || 0).toFixed(2)}%</strong></li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-6">
                            <div class="card mb-4">
                                <div class="card-header d-flex align-items-center">
                                    <i class="fas fa-brain me-2 text-primary"></i>
                                    <h5>AI-Powered Analysis</h5>
                                </div>
                                <div class="card-body" id="geminiAnalysisContainer">
                                    <div class="spinner-container">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Generating analysis...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            function renderGeminiAnalysis(container, analysis) {
                const recommendation = analysis.recommendation?.toLowerCase() || 'hold';
                const badgeClass = `bg-${recommendation}`;

                container.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">Recommendation</h6>
                        <div>
                            <span class="badge fs-6 rounded-pill ${badgeClass}">${analysis.recommendation || 'N/A'}</span>
                            <span class="ms-2 text-secondary">Confidence: ${analysis.confidence || 'N/A'}</span>
                        </div>
                    </div>
                    <p class="mb-4"><strong>Reasoning:</strong> ${analysis.reasoning || 'No reasoning provided.'}</p>
                    
                    <h6>Comprehensive Summary</h6>
                    <p class="text-secondary">${analysis.summary || 'No summary provided.'}</p>

                    <h6>Recent News & Developments</h6>
                    ${analysis.news && analysis.news.length > 0 ? `
                        <ul class="list-group list-group-flush">
                            ${analysis.news.map(item => `<li class="list-group-item">${item}</li>`).join('')}
                        </ul>
                    ` : '<p class="text-secondary">No recent news found.</p>'}
                `;
            }
            
            function createGeminiPrompt(data) {
                const { profile, quote, financials, earnings } = data;
                const profileData = `Company: ${profile?.name}, Ticker: ${profile?.ticker}, Industry: ${profile?.finnhubIndustry}.`;
                const quoteData = `Current Price: ${quote?.c}, Daily Change: ${quote?.d}, Percent Change: ${quote?.dp}%.`;
                const financialsData = `Market Cap: ${financials?.metric?.marketCapitalization}M, P/E Ratio: ${financials?.metric?.peNormalizedAnnual}, EPS: ${financials?.metric?.epsNormalizedAnnual}, 52-Week High: ${financials?.metric?.['52WeekHigh']}, 52-Week Low: ${financials?.metric?.['52WeekLow']}.`;
                const earningsData = earnings?.earningsCalendar?.[0] ? `Next earnings date: ${earnings.earningsCalendar[0].date}, EPS Estimate: ${earnings.earningsCalendar[0].epsEstimate}.` : "No upcoming earnings data.";

                return `
                    You are a financial analyst AI. Analyze the following company based on the provided data and a search of recent news.
                    
                    **Company Data:**
                    - Profile: ${profileData}
                    - Quote: ${quoteData}
                    - Key Financials: ${financialsData}
                    - Earnings Info: ${earningsData}

                    **Instructions:**
                    1.  Provide a comprehensive summary of the company's current financial health and market position.
                    2.  Search for the latest news about this company (${profile?.name} / ${profile?.ticker}). Summarize the top 2-3 most impactful news items.
                    3.  Based on all available information (the data provided and the news), give a clear investment recommendation. The recommendation must be one of: "Buy", "Sell", or "Hold".
                    4.  State your confidence level in this recommendation. The confidence level must be one of: "Low", "Medium", or "High".
                    5.  Provide a concise paragraph explaining the reasoning behind your recommendation, referencing both the data and the news.

                    Return the entire analysis as a single JSON object.
                `;
            }

            // --- UTILITY FUNCTIONS --- //
            function formatCurrency(amount) {
                return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount || 0);
            }
            
            function toYYYYMMDD(date) {
                const d = new Date(date);
                // Adjust for timezone offset to prevent date from changing
                d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
                return d.toISOString().split('T')[0];
            }

            function isMarketOpen() {
                try {
                    const now = new Date();
                    const options = {
                        timeZone: 'America/New_York',
                        weekday: 'short',
                        hour: 'numeric',
                        minute: 'numeric',
                        hour12: false
                    };
                    const formatter = new Intl.DateTimeFormat('en-US', options);
                    const parts = formatter.formatToParts(now);

                    const dayPart = parts.find(p => p.type === 'weekday');
                    const hourPart = parts.find(p => p.type === 'hour');
                    const minutePart = parts.find(p => p.type === 'minute');

                    if (!dayPart || !hourPart || !minutePart) {
                        console.error("Could not parse Eastern Time parts.");
                        return false;
                    }

                    const day = dayPart.value;
                    const hour = parseInt(hourPart.value, 10);
                    const minute = parseInt(minutePart.value, 10);
                    
                    const weekend = ['Sat', 'Sun'];
                    if (weekend.includes(day)) {
                        return false;
                    }

                    const timeInMinutes = hour * 60 + minute;
                    const marketOpenInMinutes = 9 * 60 + 30;    // 9:30 AM
                    const marketCloseInMinutes = 16 * 60;       // 4:00 PM

                    return timeInMinutes >= marketOpenInMinutes && timeInMinutes < marketCloseInMinutes;
                } catch (error) {
                    console.error("Error checking market hours:", error);
                    return false;
                }
            }
            
            // Start the application
            init();
        }

        // Wait for the DOM to be fully loaded before running the main script
        document.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>

